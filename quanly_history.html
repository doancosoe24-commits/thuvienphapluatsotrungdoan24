<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>L·ªãch s·ª≠ ƒëƒÉng nh·∫≠p (Mobile)</title>

<style>
/* ==== GI·ªÆ NGUY√äN CSS ‚Äì KH√îNG S·ª¨A ==== */
:root{
  --bg:#f1f6fb;--card:#ffffff;--muted:#6b7280;
  --accent:#0b6cff;--accent-2:#38bdf8;
  --danger:#ef4444;--success:#10b981;
  --radius:14px;--shadow:0 8px 22px rgba(12,34,63,.08);
  --max-width:720px;
  font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto
}
html,body{margin:0;background:linear-gradient(180deg,#eef7ff,#f8fbff)}
.page{max-width:var(--max-width);margin:auto;padding:14px 14px 80px}
header{position:sticky;top:0;z-index:5;display:flex;flex-direction:column;gap:8px;
  padding:12px;border-radius:12px;
  background:linear-gradient(90deg,var(--accent),var(--accent-2));
  color:#fff}
.list{display:flex;flex-direction:column;gap:12px;margin-top:12px}
.card{background:#fff;border-radius:14px;padding:12px;box-shadow:var(--shadow)}
.user{font-weight:800;color:var(--accent)}
.time{font-size:13px;color:var(--muted)}
.device,.ip{font-size:13px;word-break:break-word}
.status{padding:5px 10px;border-radius:999px;color:#fff;font-size:12px;font-weight:800}
.ok{background:var(--success)} .fail{background:var(--danger)} .unknown{background:#9ca3af}
.badge-latest{background:#ffe8a3;color:#6b4a00;font-size:11px;font-weight:900;
  padding:4px 8px;border-radius:10px;margin-left:6px}
.empty{padding:20px;text-align:center;color:var(--muted);font-weight:700}
.controls{display:flex;gap:8px}
.controls input,.controls select{
  flex:1;padding:8px;border-radius:10px;border:none;font-size:14px
}
</style>
</head>

<body>
<div class="page">
  <header>
    <div style="font-weight:800">L·ªãch s·ª≠ ƒëƒÉng nh·∫≠p</div>
    <div class="controls">
      <input id="search" placeholder="üîç T√¨m user / IP / thi·∫øt b·ªã">
      <select id="filter">
        <option value="all">T·∫•t c·∫£</option>
        <option value="ok">Th√†nh c√¥ng</option>
        <option value="fail">Th·∫•t b·∫°i</option>
      </select>
    </div>
  </header>

  <div id="list" class="list">
    <div class="empty">ƒêang t·∫£i d·ªØ li·ªáu‚Ä¶</div>
  </div>
</div>

<script>
/* ================= CONFIG ================= */
const API = 'https://script.google.com/macros/s/AKfycbxe1dxDcrRp5yYz4xNFT4iFqI14XcOzkou8hFOaV0yCgcvCsMjMpYcoyTXAEX4wRAqA/exec';

/* ================= HELPERS ================= */
function $(id){return document.getElementById(id)}
function getToken(){
  try{
    const o = JSON.parse(localStorage.getItem('loggedInUser'));
    return o && o.token ? o.token : null;
  }catch(e){return null}
}
function fetchJson(url,opt={},timeout=20000){
  return new Promise((res,rej)=>{
    const t=setTimeout(()=>rej('timeout'),timeout);
    fetch(url,opt).then(r=>r.text()).then(txt=>{
      clearTimeout(t);res(JSON.parse(txt));
    }).catch(e=>{clearTimeout(t);rej(e)})
  })
}
function escapeHtml(s){
  return String(s||'').replace(/[&<>"]/g,m=>(
    {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m]
  ))
}

/* ================= TIME (VN CHU·∫®N) ================= */
function getTimeValue(r){
  if(!r) return null;

  // ∆Øu ti√™n timestamp
  if(typeof r.ts === 'number' && !isNaN(r.ts)) return r.ts;

  let src = r.ngaygio_iso || r.ngaygio;
  if(!src) return null;

  // Chu·∫©n ISO: yyyy-MM-dd HH:mm:ss ‚Üí yyyy-MM-ddTHH:mm:ss
  if(typeof src === 'string'){
    src = src.trim();
    if(/^\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}$/.test(src)){
      src = src.replace(' ', 'T');
    }
  }

  const d = new Date(src);
  if(isNaN(d)) return null;

  return d.getTime();
}

function formatVNTime(ms){
  if(!ms || isNaN(ms)) return '‚Äî';

  return new Date(ms).toLocaleString('vi-VN',{
    timeZone:'Asia/Ho_Chi_Minh',
    hour12:false
  });
}


/* ================= STATE ================= */
let ALL_ITEMS = [];

/* ================= LOAD ================= */
async function loadLogs(){
  const token = getToken();
  if(!token){
    $('list').innerHTML='<div class="empty">Ch∆∞a ƒëƒÉng nh·∫≠p</div>';
    return;
  }

  const body = new URLSearchParams();
  body.append('route','lichsu-list');
  body.append('token',token);

  const res = await fetchJson(API,{method:'POST',body});
  if(!res || res.status!=='success'){
    $('list').innerHTML='<div class="empty">L·ªói t·∫£i d·ªØ li·ªáu</div>';
    return;
  }

  ALL_ITEMS = Array.isArray(res.data)?res.data:[];

  ALL_ITEMS.sort((a,b)=>getTimeValue(b)-getTimeValue(a));

  applyFilter();
}

/* ================= FILTER + SEARCH ================= */
function applyFilter(){
  const q = $('search').value.toLowerCase();
  const f = $('filter').value;

  const items = ALL_ITEMS.filter(r=>{
    const text = `${r.username} ${r.ip} ${r.loaithietbi}`.toLowerCase();
    if(q && !text.includes(q)) return false;

    const ok = /th√†nh|success|true/i.test(r.active||'');
    if(f==='ok' && !ok) return false;
    if(f==='fail' && ok) return false;

    return true;
  });

  render(items);
}

$('search').addEventListener('input',applyFilter);
$('filter').addEventListener('change',applyFilter);

/* ================= RENDER ================= */
function render(items){
  const list = $('list');
  if(items.length===0){
    list.innerHTML='<div class="empty">Kh√¥ng c√≥ d·ªØ li·ªáu</div>';
    return;
  }

  const newestId = items[0].id;
  list.innerHTML='';

  items.forEach(r=>{
    const statusText = r.active||'';
    const cls = /th√†nh|success|true/i.test(statusText)?'ok':
                /th·∫•t|fail|false/i.test(statusText)?'fail':'unknown';

    const timeMs = getTimeValue(r);

    const card = document.createElement('div');
    card.className='card';
    card.innerHTML=`
      <div style="display:flex;justify-content:space-between">
        <div>
          <div style="display:flex;align-items:center">
            <div class="user">${escapeHtml(r.username||'')}</div>
            ${r.id===newestId?'<span class="badge-latest">M·ªöI NH·∫§T</span>':''}
          </div>
          <div class="time">${formatVNTime(timeMs)}</div>
        </div>
        <div class="status ${cls}">${escapeHtml(statusText)}</div>
      </div>
      <div class="device">üì± ${escapeHtml(r.loaithietbi||'')}</div>
      <div class="ip">üåê ${escapeHtml(r.ip||'')}</div>
    `;
    list.appendChild(card);
  });
}

/* ================= INIT ================= */
loadLogs();
</script>
</body>
</html>
