<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>Dashboard ‚Ä¢ Th·ªëng k√™ h·ªá th·ªëng</title>

<!-- ChartJS defer ƒë·ªÉ kh√¥ng block -->
<script src="https://cdn.jsdelivr.net/npm/chart.js" defer></script>

<style>
:root{
  --bg:#f4f7fb;
  --card:#ffffff;
  --primary:#0b6cff;
  --text:#0f172a;
  --muted:#64748b;
  --success:#10b981;
  --radius:16px;
  --shadow:0 10px 28px rgba(15,23,42,.08);
  font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial;
}

*{box-sizing:border-box}
body{
  margin:0;
  background:linear-gradient(180deg,#eef5ff,#f9fbff);
  color:var(--text);
  -webkit-font-smoothing:antialiased;
}

/* ===== LAYOUT ===== */
.app{
  max-width:1200px;
  margin:auto;
  padding:12px 14px 90px;
}

/* ===== HEADER ===== */
.header{
  position:sticky;top:0;z-index:50;
  background:linear-gradient(135deg,var(--primary),#3b82f6);
  color:#fff;
  border-radius:0 0 20px 20px;
  padding:14px;
  box-shadow:var(--shadow);
}
.header-row{
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:10px;
}
.header h1{
  margin:0;
  font-size:17px;
  font-weight:800;
}
.header-actions{
  display:flex;
  gap:8px;
}
.btn{
  border:0;
  border-radius:12px;
  padding:10px 14px;
  font-weight:700;
  cursor:pointer;
}
.btn.light{
  background:rgba(255,255,255,.18);
  color:#fff;
}
.btn.primary{
  background:#fff;
  color:var(--primary);
}

/* ===== STATS GRID ===== */
.stats{
  margin-top:14px;
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
  gap:14px;
}
.card{
  background:var(--card);
  border-radius:var(--radius);
  padding:16px;
  box-shadow:var(--shadow);
}
.card .label{
  font-size:13px;
  color:var(--muted);
  font-weight:700;
}
.card .value{
  font-size:30px;
  font-weight:900;
  margin:6px 0;
  color:var(--primary);
}
.card .desc{
  font-size:13px;
  color:var(--muted);
}

/* ===== CHARTS ===== */
.charts{
  margin-top:16px;
  display:grid;
  grid-template-columns:1fr;
  gap:14px;
}
@media(min-width:900px){
  .charts{grid-template-columns:2fr 1fr;}
}
.chart-card{
  background:var(--card);
  border-radius:var(--radius);
  padding:14px;
  box-shadow:var(--shadow);
}
.chart-title{
  font-weight:800;
  margin-bottom:6px;
}

/* ===== TABLE ===== */
.table-card{
  margin-top:16px;
  background:var(--card);
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  padding:14px;
}
.table-head{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:8px;
}
.table-head strong{font-size:15px}
.small{font-size:13px;color:var(--muted)}

table{
  width:100%;
  border-collapse:collapse;
}
th,td{
  padding:10px 8px;
  font-size:14px;
  border-bottom:1px solid #eef2f7;
}
th{
  text-transform:uppercase;
  font-size:12px;
  color:var(--muted);
  text-align:left;
}

/* ===== LOADING ===== */
.loading{
  opacity:.6;
  pointer-events:none;
}

/* ===== MOBILE TWEAK ===== */
@media(max-width:520px){
  .card .value{font-size:26px}
}
</style>
</head>

<body>
<div class="app" id="app">

  <!-- HEADER -->
  <div class="header">
    <div class="header-row">
      <h1>üìä Dashboard th·ªëng k√™</h1>
      <div class="header-actions">
        <button id="btnReload" class="btn light">‚ü≥</button>
        <button id="btnCancel" class="btn light" style="display:none">‚úï</button>
      </div>
    </div>
  </div>

  <!-- STATS -->
  <div class="stats">
    <div class="card">
      <div class="label">T·ªïng ng∆∞·ªùi d√πng</div>
      <div class="value" id="totalUsers">‚Äî</div>
      <div class="desc" id="usersBreakdown">Admin ‚Äî ¬∑ Editor ‚Äî ¬∑ User ‚Äî</div>
    </div>

    <div class="card">
      <div class="label">T·ªïng t√†i li·ªáu</div>
      <div class="value" id="totalDocs">‚Äî</div>
      <div class="desc" id="docsBreakdown">Public ‚Äî ¬∑ Kh√¥ng g√°n ‚Äî</div>
    </div>

    <div class="card">
      <div class="label">Editor c√≥ t√†i li·ªáu</div>
      <div class="value" id="totalEditors">‚Äî</div>
      <div class="desc">Editors ƒë∆∞·ª£c ph√¢n quy·ªÅn</div>
    </div>

    <div class="card">
      <div class="label">Ghi ch√∫</div>
      <div class="desc">Editor ch·ªâ xem t√†i li·ªáu ƒë∆∞·ª£c admin c·∫•p quy·ªÅn.</div>
    </div>
  </div>

  <!-- CHARTS -->
  <div class="charts">
    <div class="chart-card">
      <div class="chart-title">Ph√¢n quy·ªÅn ng∆∞·ªùi d√πng</div>
      <canvas id="rolesChart" height="180"></canvas>
    </div>
    <div class="chart-card">
      <div class="chart-title">T√†i li·ªáu theo editor</div>
      <canvas id="docsPerEditorChart" height="180"></canvas>
    </div>
  </div>

  <!-- RECENT -->
  <div class="table-card">
    <div class="table-head">
      <strong>T√†i li·ªáu g·∫ßn nh·∫•t</strong>
      <span class="small">T·ªëi ƒëa 10</span>
    </div>
    <table>
      <thead>
        <tr><th>ID</th><th>Ti√™u ƒë·ªÅ</th></tr>
      </thead>
      <tbody id="recentTable">
        <tr><td colspan="2" style="text-align:center">ƒêang t·∫£i...</td></tr>
      </tbody>
    </table>
  </div>

</div>

<script>
/* ===== CONFIG ===== */
const API = "https://script.google.com/macros/s/AKfycbxgidwuQo9UTNHrb85ZFbY7YyKGWxR1HHLtLGpfbu4ILyMGHbSj7b0XrYSCsZEv8XjW/exec";
let aborter=null, rolesChart=null, docsChart=null;

/* ===== HELPERS ===== */
const $=id=>document.getElementById(id);
const token=()=>{try{return JSON.parse(localStorage.getItem('loggedInUser'))?.token}catch(e){return null}};
const setLoading=v=>document.body.classList.toggle('loading',v);

/* ===== CHART ===== */
function doughnut(ctx,l,v){
  if(rolesChart){rolesChart.data.labels=l;rolesChart.data.datasets[0].data=v;rolesChart.update();return}
  rolesChart=new Chart(ctx,{type:'doughnut',data:{labels:l,datasets:[{data:v,backgroundColor:['#0b6cff','#22c55e','#94a3b8']}]},options:{plugins:{legend:{position:'bottom'}}}});
}
function bar(ctx,l,v){
  if(docsChart){docsChart.data.labels=l;docsChart.data.datasets[0].data=v;docsChart.update();return}
  docsChart=new Chart(ctx,{type:'bar',data:{labels:l,datasets:[{data:v,backgroundColor:'#0b6cff'}]},options:{plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}});
}

/* ===== MAIN LOAD ===== */
async function loadDashboard(){
  if(aborter) aborter.abort();
  aborter=new AbortController();
  setLoading(true);

  const tk=token();
  if(!tk){location.href='index.html';return}

  try{
    const [chk,docs,all]=await Promise.all([
      fetch(`${API}?route=check-manager&token=${tk}`).then(r=>r.json()),
      fetch(API,{method:'POST',body:new URLSearchParams({route:'tailieu-list',token:tk})}).then(r=>r.json()),
      fetch(API).then(r=>r.json())
    ]);

    if(!chk.isManager){alert('Kh√¥ng c√≥ quy·ªÅn');return}

    const users=all.data.Users||[];
    const docsArr=docs.data||[];

    const roles={admin:0,editor:0,user:0};
    users.forEach(u=>roles[(u.role||'user').toLowerCase()]++);

    const docsByEditor={}, stats={public:0,none:0};
    docsArr.forEach(d=>{
      if(!d.quyen){stats.none++;return}
      if(d.quyen.toLowerCase().includes('all')){stats.public++;return}
      d.quyen.split(',').forEach(x=>{
        x=x.trim(); if(!x) return;
        docsByEditor[x]=(docsByEditor[x]||0)+1;
      });
    });

    requestAnimationFrame(()=>{
      $('totalUsers').textContent=users.length;
      $('usersBreakdown').textContent=`Admin ${roles.admin} ¬∑ Editor ${roles.editor} ¬∑ User ${roles.user}`;
      $('totalDocs').textContent=docsArr.length;
      $('docsBreakdown').textContent=`Public ${stats.public} ¬∑ Kh√¥ng g√°n ${stats.none}`;
      const edAssigned=users.filter(u=>u.role==='editor'&&docsByEditor[u.id]).length;
      $('totalEditors').textContent=`${edAssigned} / ${roles.editor}`;
    });

    requestIdleCallback(()=>{
      doughnut($('rolesChart').getContext('2d'),['Admin','Editor','User'],[roles.admin,roles.editor,roles.user]);
      const top=Object.entries(docsByEditor).slice(0,8);
      bar($('docsPerEditorChart').getContext('2d'),top.map(x=>x[0]),top.map(x=>x[1]));
    });

  const tb = $('recentTable');
    tb.innerHTML = '';

    docsArr
      .filter(d => d.name && String(d.name).trim() !== '')
      .slice(0, 10)
      .forEach(d => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${d.id ?? ''}</td>
          <td>${d.name}</td>
        `;
        tb.appendChild(tr);
      });


  }catch(e){console.error(e)}
  finally{setLoading(false)}
}

/* ===== EVENTS ===== */
$('btnReload').onclick=loadDashboard;
$('btnCancel').onclick=()=>aborter&&aborter.abort();
window.onload=loadDashboard;
</script>
</body>
</html>
