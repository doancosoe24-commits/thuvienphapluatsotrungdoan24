<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Upload + Save Message</title>
</head>
<body>
  <h2>Upload file và lưu vào bảng messages</h2>
  
  <input type="file" id="fileInput" />
  <button id="uploadBtn">Upload & Save</button>
  
  <div id="result"></div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.47.4/dist/umd/supabase.js"></script>
  <script>
    const SUPABASE_URL = "https://jpmyyuqzxhlbuegjapfs.supabase.co";
    const SUPABASE_KEY = "sb_publishable_GBmZcFie8VAgpO-9oCH0Ww_awOqrA3J"; 
    const STORAGE_BUCKET = "chat-uploads";

    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    const localUser = { id: "user123", name: "Vu" };
    const activeUserId = "user456";

    async function uploadAndSave() {
      const fileInput = document.getElementById("fileInput");
      const file = fileInput.files[0];
      const resultDiv = document.getElementById("result");

      if (!file) {
        alert("Vui lòng chọn file!");
        return;
      }

      resultDiv.innerHTML = "<p>Đang upload...</p>";

      const filePath = `${Date.now()}_${file.name.replace(/\s+/g,'_')}`;

      const { error: uploadError } = await supabaseClient
        .storage
        .from(STORAGE_BUCKET)
        .upload(filePath, file, { upsert: true });

      if (uploadError) {
        resultDiv.innerHTML = "<p style='color:red'>Upload thất bại: " + uploadError.message + "</p>";
        return;
      }

      const { data: publicData } = supabaseClient
        .storage
        .from(STORAGE_BUCKET)
        .getPublicUrl(filePath);

      const fileUrl = publicData.publicUrl;

      const { data: msgData, error: msgError } = await supabaseClient
        .from("messages")
        .insert({
          sender: localUser.id,
          user_name: localUser.name,
          recipient: activeUserId,
          content: fileUrl, // lưu link vào cột content
          meta: { type: "file", name: file.name }
        })
        .select();

      if (msgError) {
        resultDiv.innerHTML = "<p style='color:red'>Insert thất bại: " + msgError.message + "</p>";
        return;
      }

      resultDiv.innerHTML = `
        <p style="color:green">Upload + lưu message thành công!</p>
        <p>File URL: <a href="${fileUrl}" target="_blank">${fileUrl}</a></p>
        <p>Message ID: ${msgData[0].id}</p>
      `;
    }

    document.getElementById("uploadBtn").addEventListener("click", uploadAndSave);
  </script>
</body>
</html>
