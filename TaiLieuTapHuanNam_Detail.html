<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <link rel="shortcut icon" href="./img/logo1.jpg" type="image/x-icon">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Thư Viện Pháp Luật Số - Chi Tiết</title>

  <style>
    html, body { margin:0; height:100%; font-family: Arial, sans-serif; background:#f7f9fb; color:#333; }
    body { display:flex; flex-direction:column; width:70%; margin:0 auto; }
    main { flex:1; padding:20px 0; }

    .item_list { display:flex; align-items:center; margin-bottom:18px; }
    .arrow { width:120px;height:45px;background:#ccae6e;
      clip-path: polygon(0% 0%,78% 0%,100% 50%,78% 100%,0% 100%,18% 50%);
      display:flex;align-items:center;justify-content:center;
      font-weight:700;color:#8c6d2a;margin-right:12px;
    }
    .item {
      background:#004aad; flex:1; display:flex; flex-direction:column;
      padding:15px 5px; color:#ccae6e; border-radius:5px;
      box-shadow:0 3px 6px rgba(0,0,0,0.15); cursor:pointer;
      transition:0.3s; text-align:start;
    }
    .item p { margin:0 0 6px 0; font-weight:700; font-size:16px; }
    .item:hover{ background:#ccae6e; color:#fff; }
    .btn-new {
      background:#ff3131; color:#ffde59; font-weight:700; border:none;
      padding:8px 16px; border-radius:10px; margin-top:6px;
      cursor:pointer; font-size:12px; transition:0.2s;
    }
    .back-link {
      color:#ccae6e; padding:10px; font-weight:600;
      text-decoration:underline; cursor:pointer; display:inline-block;
    }

    @media(max-width:768px){
      body { width:100%; }
      .arrow { width:50px;height:35px;font-size:11px; }
      .item p { font-size:14px; }
      .btn-new { padding:6px 12px;font-size:11px; }
    }

    #loadingBox {
      display:flex;
      flex-direction:column;
      justify-content:center;
      align-items:center;
      padding:40px 0;
      color:#ccae6e;
      font-size:17px;
      font-weight:600;
    }

    .loader {
      width:45px;
      height:45px;
      border:4px solid #ccae6e;
      border-top-color:transparent;
      border-radius:50%;
      animation:spin 0.7s linear infinite;
      margin-bottom:12px;
    }

    @keyframes spin { to { transform:rotate(360deg); } }
  </style>
</head>

<body>

<div id="header"></div>

<main>
  <span class="back-link" onclick="history.back()">Quay lại</span>
  <h2 id="pageTitle" style="text-align:center;color:#ccae6e;text-transform:uppercase;"></h2>

  <div id="loadingBox">
      <div class="loader"></div>
      Đang tải dữ liệu...
  </div>

  <div id="list" style="display:none;"></div>
</main>

<div id="footer"></div>

<script>
const webAppUrl = "https://script.google.com/macros/s/AKfycbyxCsXIZzJAL3TnEoSZaAGIbfjOZJ9lbBfMxqUQx5_-6UKsIaHcOmERT1hp8Z3k9fC6/exec";

// Chuyển text thành slug chuẩn hóa (giữ D/Đ, bỏ dấu các ký tự khác)
function normalizeTitle(text){
  return String(text || "")
    .normalize("NFD") // tách dấu
    .replace(/[\u0300-\u036f]/g,"") // bỏ dấu
    .replace(/[^a-zA-Z0-9Đđ]/g,"") // giữ a-z, A-Z, 0-9, Đ, đ
    .toUpperCase();
}

// Escape HTML
function escapeHtml(str){
  if(!str) return "";
  return String(str)
    .replace(/&/g,"&amp;")
    .replace(/</g,"&lt;")
    .replace(/>/g,"&gt;")
    .replace(/"/g,"&quot;")
    .replace(/'/g,"&#39;");
}

// Lấy slug từ URL
function getSlugFromURL(){
  const url = new URL(window.location.href);
  return url.searchParams.get("slug") || "";
}

// Load page
async function loadPage(){
  try{
    const pageSlug = getSlugFromURL();

    const [ res] = await Promise.all([
      fetch(webAppUrl).then(r=>r.json())
    ]);
    const rawList = res.TaiLieuTapHuan || [];

    // Filter items matching slug
    const matched = rawList.filter(d => normalizeTitle(d.title) === pageSlug.toUpperCase());

    if(matched.length === 0){
      document.getElementById("pageTitle").textContent = "KHÔNG TÌM THẤY TÀI LIỆU";
      document.getElementById("list").textContent = "Không có tài liệu trùng khớp.";
      document.getElementById("loadingBox").style.display = "none";
      return;
    }

    // Hiển thị title đầu tiên
    const doc = matched[0];
    document.getElementById("pageTitle").textContent = doc.title.toUpperCase();

    renderList(matched);

  } catch(err){
    console.error("❌ Lỗi loadPage:", err);
    document.getElementById("list").textContent = "Không thể tải dữ liệu.";
    document.getElementById("loadingBox").style.display = "none";
  }
}

// Render list chỉ khi name tồn tại
function renderList(data){
  const list = document.getElementById("list");
  list.innerHTML = "";

  const frag = document.createDocumentFragment();
  const loading = document.getElementById("loadingBox");

  data.forEach(i=>{
    if(!i.name || !i.name.trim()) return;

    const div = document.createElement("div");
    div.className = "item_list";
    div.innerHTML = `
      <div class="arrow"></div>
      <div class="item" data-name="${escapeHtml(i.name)}">
        <p>${escapeHtml(i.name)}</p>
      </div>
    `;
    frag.appendChild(div);
  });

  list.appendChild(frag);

  loading.style.display = "none";
  list.style.display = "block";

  // Click -> detail page (slug = name của item click)
  list.onclick = e=>{
    const item = e.target.closest(".item");
    if(item){
      const nameClicked = item.dataset.name;
      const nSlug = normalizeTitle(nameClicked); // slug = normalize name
      window.location.href = `detail_taphuannam.html?slug=${nSlug}`;
    }
  };
}

loadPage();
</script>

</body>
</html>
