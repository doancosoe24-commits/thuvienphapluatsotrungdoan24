<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Kết quả tìm kiếm</title>
<style>
html, body { height: 100%; margin: 0; font-family: Arial,sans-serif; background:#f7f9fb; }
body { display: flex; flex-direction: column; width: 70%; margin: 0 auto; }
main { flex: 1; padding: 20px 0; }
h2 { color: #004aad; }
.keyword { color: #ff3131; font-weight: bold; }
main h2{ width: 100%; background: #004aad; color: #fff; font-size: 20px; padding:5px; }
.item_list { display: flex; align-items: center; width: 100%; margin: 10px 0;}
.arrow {
    width: 120px; height: 45px;
    background: #ccae6e;
    clip-path: polygon(0% 0%, 78% 0%, 100% 50%, 78% 100%, 0% 100%, 18% 50%);
    display: flex; align-items: center; justify-content: center;
    font-weight: 700; color: #8c6d2a; font-size: 13px;
    margin-right: 12px;
}
.items {
    background: #004aad;
    flex: 1;
    display: flex;
    flex-direction: column;
    padding: 10px 5px;
    color: #fff;
    border-radius: 5px;
    box-shadow: 0 3px 6px rgba(0,0,0,0.15);
    cursor: pointer;
}
.items p { margin: 0 0 6px 0; font-size: 16px; font-weight: 700; }
.btn-new {
    background: #ff3131; color: #ffde59; font-weight: 700;
    border: none; padding: 8px 16px; border-radius: 10px;
    cursor: pointer; font-size: 12px; align-self: flex-end;
    transition: 0.2s;
}

/* LOADING BOX */
#loadingBox {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 40px 0;
  font-size: 16px;
  font-weight: 600;
  color: #ccae6e;
}
.loader {
  width: 45px;
  height: 45px;
  border: 4px solid #ccae6e;
  border-top-color: transparent;
  border-radius: 50%;
  animation: spin 0.5s linear infinite;
  margin-bottom: 12px;
}
@keyframes spin { to { transform: rotate(360deg); } }

@media (max-width:768px) {
    body{ width: 100%; }
    .arrow { width: 80px; height: 35px; }
    .items p{ font-size: 14px; }
}
</style>
</head>
<body>
<div id="header"></div>
<main>
<h2>Từ khóa: <span id="searchKey"></span></h2>

<!-- Loading -->
<div id="loadingBox">
  <div class="loader"></div>
  Đang tra dữ liệu...
</div>

<div id="results" style="display:none;"></div>
</main>
<div id="footer"></div>

<script>
const webAppUrl = "https://script.google.com/macros/s/AKfycbyxCsXIZzJAL3TnEoSZaAGIbfjOZJ9lbBfMxqUQx5_-6UKsIaHcOmERT1hp8Z3k9fC6/exec"; 
const params = new URLSearchParams(window.location.search);
const key = params.get("key")?.trim() || "";
const keyLower = key.toLowerCase();
document.getElementById("searchKey").textContent = key || "không có";

const ref = window.location.origin;

function createSlug(title){
  if(!title) return "";
  title = title.replace(/Đ/g,"D").replace(/đ/g,"d");
  let str = title.normalize("NFD").replace(/[\u0300-\u036f]/g,"");
  return str.split(/\s+/).map(w =>
    w.replace(/[^a-zA-Z0-9]/g,"").replace(/^./, c=>c.toUpperCase())
  ).join("");
}

async function loadAndFilter(){
    const resultsDiv = document.getElementById("results");
    const loadingDiv = document.getElementById("loadingBox");

    resultsDiv.style.display = "none";
    loadingDiv.style.display = "flex";

    if(!key){
        loadingDiv.style.display = "none";
        resultsDiv.style.display = "block";
        resultsDiv.innerHTML = "<p>Không có từ khóa.</p>";
        return;
    }

    try{
        const res = await fetch(`${webAppUrl}?ref=${encodeURIComponent(ref)}`);
        const allData = await res.json();

        const items = allData.ThuVienPhapLuatSo || [];
        const filtered = items.filter(item => item.title && item.title.toLowerCase().includes(keyLower));

        loadingDiv.style.display = "none";
        resultsDiv.style.display = "block";

        if(filtered.length===0){
            resultsDiv.innerHTML = "<p>Không tìm thấy kết quả.</p>";
            return;
        }

        filtered.forEach(item=>{
            const slug = createSlug(item.title);
            const div = document.createElement("div");
            div.className = "item_list";
            div.innerHTML = `
                <div class="arrow"></div>
                <div class="items">
                    <p>${item.title}</p>
                    <button class="btn-new">Có hiệu lực</button>
                </div>
            `;
            div.querySelector(".items").addEventListener("click", ()=>{
                window.location.href = `detail.html?slug=${encodeURIComponent(slug)}`;
            });
            resultsDiv.appendChild(div);
        });
    }catch(err){
        console.error("Lỗi load API", err);
        loadingDiv.style.display = "none";
        resultsDiv.style.display = "block";
        resultsDiv.innerHTML = "<p>Không thể tải dữ liệu.</p>";
    }
}

loadAndFilter();

// Load header + footer
function loadHTML(id, url) {
  fetch(url)
    .then(res => res.ok ? res.text() : Promise.reject('Network error'))
    .then(html => {
      document.getElementById(id).innerHTML = html;

      if(id==='header'){
        const searchBtn = document.getElementById("searchBtn");
        const searchInput = document.getElementById("searchInput");
        if(searchBtn && searchInput){
          searchBtn.addEventListener("click", ()=>{
            const key = searchInput.value.trim();
            if(!key) return;
            window.location.href = `timkiem.html?key=${encodeURIComponent(key)}`;
          });
          searchInput.addEventListener("keyup", e=>{
            if(e.key==="Enter") searchBtn.click();
          });
        }
      }
    })
    .catch(err => console.error(`Error loading ${url}:`, err));
}

loadHTML('header','header.html');
loadHTML('footer','footer.html');
</script>
</body>
</html>
