<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin ‚Äî Qu·∫£n l√Ω Users (Mobile-first)</title>
  <link rel="shortcut icon" href="./img/logo.png" type="image/x-icon">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg: #f4f7fb;
      --surface: #ffffff;
      --muted: #6b7280;
      --text: #0f172a;
      --accent: #0b6cff;
      --accent-2: #06b6d4;
      --danger: #ef4444;
      --success: #10b981;
      --radius: 14px;
      --shadow: 0 10px 30px rgba(15,23,42,0.06);
      --glass: rgba(255,255,255,0.6);
      --maxw: 1100px;
      --ease: cubic-bezier(.2,.9,.25,1);
    }

    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:linear-gradient(180deg,var(--bg),#eef6ff);font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial;color:var(--text);-webkit-font-smoothing:antialiased}
    a{color:inherit}

    /* App container */
    .wrap{max-width:var(--maxw);margin:18px auto;padding:12px}

    /* Topbar */
    .top{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:14px}
    .brand{display:flex;gap:12px;align-items:center}
    .logo{width:56px;height:56px;border-radius:12px;overflow:hidden;background:linear-gradient(135deg,var(--accent),var(--accent-2));display:grid;place-items:center;color:#fff;font-weight:800}
    .brand h1{margin:0;font-size:18px}
    .brand p{margin:0;font-size:13px;color:var(--muted)}

    /* Card */
    .card{background:var(--surface);border-radius:var(--radius);padding:12px;box-shadow:var(--shadow)}

    /* Toolbar */
    .toolbar{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .search{flex:1;min-width:180px;display:flex;align-items:center;background:#f8fafc;padding:8px;border-radius:12px}
    .search svg{opacity:.6}
    .search input{border:0;background:transparent;outline:none;padding:8px;font-size:14px;flex:1}
    .controls{display:flex;gap:8px}
    .btn{padding:9px 12px;border-radius:10px;border:0;background:var(--accent);color:#fff;font-weight:600;cursor:pointer;box-shadow:0 8px 20px rgba(11,108,255,0.08);transition:transform .18s var(--ease)}
    .btn.ghost{background:transparent;border:1px solid rgba(15,23,42,0.06);color:var(--text);box-shadow:none}
    .btn:active{transform:scale(.98)}

    /* table (desktop) */
    .table-wrap{margin-top:12px;border-radius:10px;overflow:auto}
    table{width:100%;border-collapse:collapse;min-width:820px}
    thead th{font-size:12px;color:var(--muted);text-transform:uppercase;padding:12px 14px;text-align:left;white-space:nowrap}
    tbody td{padding:12px 14px;border-bottom:1px solid rgba(15,23,42,0.04);vertical-align:middle}
    tbody tr{transition:background .18s var(--ease)}
    tbody tr:hover{background:linear-gradient(90deg, rgba(6,182,212,0.02), rgba(11,108,255,0.02))}

    .row-actions{display:flex;gap:8px;flex-wrap:wrap}
    .chip{padding:6px 8px;border-radius:999px;font-size:12px;background:rgba(15,23,42,0.04);display:inline-flex;align-items:center;gap:8px}
    .badge{padding:6px 8px;border-radius:8px;font-size:12px;color:#fff}
    .badge.admin{background:#0ea5b7}
    .badge.editor{background:#60a5fa}
    .badge.user{background:#94a3b8}
    .badge.lock{background:var(--danger)}
    .badge.ok{background:var(--success)}

    /* responsive: cards for small screens */
    @media (max-width:880px){
      table{min-width:0}
      thead{display:none}
      tbody td{display:block;padding:12px 14px}
      tbody tr{display:block;background:linear-gradient(180deg,var(--surface),#fbfdff);border-radius:12px;margin-bottom:12px;padding:12px}
      tbody td:before{content:attr(data-label);display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
      .controls{width:100%;justify-content:flex-end}
    }

    /* modal */
    .modal-backdrop{position:fixed;inset:0;background:rgba(2,6,23,0.45);display:none;align-items:center;justify-content:center;padding:18px;z-index:999}
    .modal{background:var(--surface);border-radius:12px;padding:14px;max-width:720px;width:100%;box-shadow:var(--shadow);transform:translateY(8px);transition:all .18s var(--ease)}
    .modal.show{transform:none}
    .form-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .form-row{margin-bottom:8px}
    label{font-size:13px;color:var(--muted);display:block;margin-bottom:6px}
    input[type=text],input[type=email],input[type=password],select,textarea{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(15,23,42,0.06)}
    textarea{min-height:96px}

    /* tiny helpers */
    .muted{font-size:13px;color:var(--muted)}
    .small{font-size:12px;color:var(--muted)}
    .float-add{position:fixed;right:18px;bottom:100px;width:56px;height:56px;border-radius:999px;background:linear-gradient(135deg,var(--accent),var(--accent-2));display:grid;place-items:center;color:#fff;font-size:22px;box-shadow:0 12px 30px rgba(11,108,255,0.12);z-index:80}

    /* skeleton */
    .skeleton{background:linear-gradient(90deg, rgba(0,0,0,0.04), rgba(0,0,0,0.06), rgba(0,0,0,0.04));border-radius:8px;height:14px}

    /* toast */
    .toast{position:fixed;left:50%;top:18px;transform:translateX(-50%);background:#111;color:#fff;padding:10px 14px;border-radius:10px;display:none;z-index:1100}
    .toast.show{display:block}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <div>
          <h1>Qu·∫£n l√Ω t√†i kho·∫£n</h1>
        </div>
      </div>
      <div class="toolbar">
        <div class="search" role="search" aria-label="T√¨m nhanh">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M21 21l-4.35-4.35" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"></path><path d="M11 19a8 8 0 100-16 8 8 0 000 16z" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"></path></svg>
          <input id="q" placeholder="T√¨m username, email, ng√†y t·∫°o..." aria-label="T√¨m ki·∫øm" />
        </div>
        <div class="controls">
          <button id="reload" class="btn ghost" title="L√†m m·ªõi">‚ü≥</button>
          <button id="openAdd" class="btn" title="Th√™m t√†i kho·∫£n">+ Th√™m</button>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="table-wrap" id="tableWrap">
        <table aria-describedby="user-table">
          <thead>
            <tr>
              <th>Username</th>
              <th>Email</th>
              <th>Role</th>
              <th>Active</th>
              <th>Can view</th>
              <th>Kh√≥a</th>
              <th>Ng√†y t·∫°o</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="tbody">
            <!-- rows injected -->
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- floating add (mobile) -->
  <button id="fab" class="float-add" aria-label="Th√™m t√†i kho·∫£n">+</button>

  <!-- modal -->
  <div id="backdrop" class="modal-backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <h3 id="modalTitle">Th√™m / S·ª≠a t√†i kho·∫£n</h3>
      <div class="form-grid">
        <div>
          <div class="form-row">
            <label>Username</label>
            <input id="username" type="text" placeholder="username" />
          </div>
          <div class="form-row">
            <label>Email</label>
            <input id="email" type="email" placeholder="email@domain" />
          </div>
          <div class="form-row">
            <label>M·∫≠t kh·∫©u (ƒë·ªÉ tr·ªëng n·∫øu kh√¥ng ƒë·ªïi)</label>
            <input id="password" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
          </div>
        </div>
        <div>
          <div class="form-row">
            <label>Role</label>
            <select id="role">
              <option value="user">user</option>
              <option value="editor">editor</option>
              <option value="admin">admin</option>
            </select>
          </div>
          <div class="form-row">
            <label>Active</label>
            <select id="active">
              <option value="1">Active</option>
              <option value="0">Inactive</option>
            </select>
          </div>
          <div class="form-row">
            <label>Can view</label>
            <select id="can_view" multiple size="6" style="min-height:120px"></select>
            <div class="small">Ch·ªçn user m√† t√†i kho·∫£n n√†y ƒë∆∞·ª£c ph√©p xem t√†i li·ªáu. Ch·ªçn "all" ƒë·ªÉ cho ph√©p t·∫•t c·∫£.</div>
          </div>
        </div>
      </div>

      <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px">
        <button id="cancel" class="btn ghost">H·ªßy</button>
        <button id="save" class="btn">L∆∞u</button>
      </div>
    </div>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <script>
    // --- CONFIG ---
    const API = 'https://script.google.com/macros/s/AKfycbzUuQFf7PNcRJR-MxW03F2aTuDY5_BQXbqJXB0K1PdAJomdFgvHVZkirmIB24CbZnBk/exec';

    // --- AUTH (t∆∞∆°ng t·ª± project c·ªßa b·∫°n) ---
    const raw = localStorage.getItem('loggedInUser');
    if(!raw){ alert('B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p'); window.location.href = '/login.html'; }
    let token = '';
    try{ const parsed = JSON.parse(raw); token = parsed.token || (parsed.user && parsed.user.token) || parsed.accessToken || ''; }catch(e){ console.error(e); }

    // --- elements ---
    const tbody = document.getElementById('tbody');
    const q = document.getElementById('q');
    const reload = document.getElementById('reload');
    const openAdd = document.getElementById('openAdd');
    const fab = document.getElementById('fab');
    const backdrop = document.getElementById('backdrop');
    const usernameInput = document.getElementById('username');
    const emailInput = document.getElementById('email');
    const passwordInput = document.getElementById('password');
    const roleInput = document.getElementById('role');
    const activeInput = document.getElementById('active');
    const canViewSelect = document.getElementById('can_view');
    const saveBtn = document.getElementById('save');
    const cancelBtn = document.getElementById('cancel');
    const toast = document.getElementById('toast');

    let users = [];
    let editingId = null;

    // helpers
    function showToast(msg){ toast.textContent = msg; toast.classList.add('show'); setTimeout(()=>{ toast.classList.remove('show'); }, 2600); }
    function escapeHtml(s){ return String(s||'').replace(/[&<>\"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"})[c]); }
    function formatDate(v){ try{ const d = new Date(Number(v) || v); if(isNaN(d)) return v; return d.toLocaleString(); }catch(e){ return v; } }

    // debounce helper
    function debounce(fn, ms=250){ let t; return (...args)=>{ clearTimeout(t); t = setTimeout(()=>fn.apply(this,args), ms); }; }

    // fetch list
    async function fetchUsers(){ tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;padding:18px">ƒêang t·∫£i d·ªØ li·ªáu...</td></tr>'; try{
        const body = new URLSearchParams({ route:'users-list', token });
        const res = await fetch(API, { method:'POST', body });
        const json = await res.json();
        if(!json || json.status !== 'success'){ tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;padding:18px">Kh√¥ng th·ªÉ l·∫•y d·ªØ li·ªáu</td></tr>'; showToast((json && json.message) || 'L·ªói khi t·∫£i danh s√°ch'); return; }
        users = json.data || [];
        renderTable(users);
        populateCanView(users);
      }catch(e){ console.error(e); tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;padding:18px">L·ªói khi t·∫£i</td></tr>'; showToast('L·ªói khi t·∫£i d·ªØ li·ªáu'); }
    }

    function populateCanView(list){ canViewSelect.innerHTML = ''; const optAll = document.createElement('option'); optAll.value = 'all'; optAll.textContent = 'all (t·∫•t c·∫£)'; canViewSelect.appendChild(optAll); list.forEach(u=>{ const o = document.createElement('option'); o.value = u.id || u.email || u.username; o.textContent = u.username || u.email || u.id; canViewSelect.appendChild(o); }); }

    function renderTable(list){ if(!list || !list.length){ tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;padding:18px">Kh√¥ng c√≥ d·ªØ li·ªáu</td></tr>'; return; }
      tbody.innerHTML = list.map(u => {
        const canViewText = (u.can_view && String(u.can_view).toLowerCase()==='all') ? 'all' : (u.can_view || '-');
        const active = (String(u.active) === '1' || String(u.active).toLowerCase()==='true');
        const locked = (u.lock_until && Date.now() < Number(u.lock_until));
        return `
          <tr data-id="${escapeHtml(u.id)}">
            <td data-label="Username">${escapeHtml(u.username||'')}</td>
            <td data-label="Email">${escapeHtml(u.email||'')}</td>
            <td data-label="Role"><span class="badge ${escapeHtml((u.role||'user').toLowerCase())}">${escapeHtml(u.role||'user')}</span></td>
            <td data-label="Active">${active?'<span class="badge ok">Active</span>':'<span class="chip">Inactive</span>'}</td>
            <td data-label="Can view"><div class="small">${escapeHtml(canViewText)}</div></td>
            <td data-label="Kh√≥a">${locked?`<span class='badge lock'>Kh√≥a t·ªõi ${formatDate(u.lock_until)}</span>`:'-'}</td>
            <td data-label="Ng√†y t·∫°o">${formatDate(u.created_at||u.createdAt||u.created)}</td>
            <td data-label="H√†nh ƒë·ªông">
              <div class="row-actions">
                <button class="btn ghost" data-action="edit" data-id="${escapeHtml(u.id)}">‚úè</button>
                <button class="btn ghost" data-action="lock" data-id="${escapeHtml(u.id)}">üîí</button>
                <button class="btn ghost" data-action="role" data-id="${escapeHtml(u.id)}">‚áÑ</button>
                <button class="btn" data-action="delete" data-id="${escapeHtml(u.id)}" style="background:${'#ef4444'}">üóë</button>
              </div>
            </td>
          </tr>`; }).join('');

      attachRowEvents();
    }

    function attachRowEvents(){ tbody.querySelectorAll('button[data-action]').forEach(btn => {
      btn.onclick = async (e) => {
        const act = btn.dataset.action; const id = btn.dataset.id;
        if(act === 'edit'){ const user = users.find(x=>String(x.id)===String(id)); openModal(user); }
        if(act === 'delete'){ if(!confirm('X√≥a user? H√†nh ƒë·ªông kh√¥ng th·ªÉ ho√†n t√°c.')) return; await apiCall('users-delete', { id }); }
        if(act === 'role'){ if(!confirm('Chuy·ªÉn role c·ªßa user?')) return; const user = users.find(x=>String(x.id)===String(id)); const newRole = (user && String(user.role).toLowerCase() === 'admin') ? 'user' : 'admin'; await apiCall('users-update', { id, role: newRole }); }
        if(act === 'lock'){ if(!confirm('Thao t√°c kh√≥a/m·ªü kh√≥a?')) return; const user = users.find(x=>String(x.id)===String(id)); const currentlyLocked = (user && user.lock_until && Date.now() < Number(user.lock_until)); const lockUntil = currentlyLocked ? 0 : (Date.now() + 20*365*24*60*60*1000); await apiCall('users-update', { id, lock_until: String(lockUntil) }); }
      };
    }); }

    async function apiCall(route, params){ try{
        const body = new URLSearchParams({ route, token, ...params });
        const res = await fetch(API, { method:'POST', body });
        const json = await res.json();
        if(json && (json.status === 'success' || json.success)){ showToast(json.message || 'Th√†nh c√¥ng'); await fetchUsers(); closeModal(); } else { showToast((json && json.message) || 'L·ªói khi g·ªçi API'); }
      }catch(e){ console.error(e); showToast('L·ªói k·∫øt n·ªëi'); }
    }

    // modal open/close
    function openModal(user=null){ editingId = user && user.id ? user.id : null; usernameInput.value = user?.username || ''; emailInput.value = user?.email || ''; passwordInput.value=''; roleInput.value = user?.role || 'user'; activeInput.value = (user && (String(user.active) === '1' || String(user.active).toLowerCase()==='true')) ? '1' : '0';
      // pre-select can_view
      Array.from(canViewSelect.options).forEach(o=> o.selected = false);
      if(user && user.can_view){ if(String(user.can_view).toLowerCase()==='all') { const opt = Array.from(canViewSelect.options).find(o=>o.value==='all'); if(opt) opt.selected = true; } else { const arr = String(user.can_view).split(',').map(x=>x.trim()); arr.forEach(v=>{ const opt = Array.from(canViewSelect.options).find(o=>o.value===v); if(opt) opt.selected = true; }); } }
      backdrop.style.display = 'flex'; backdrop.setAttribute('aria-hidden','false'); backdrop.querySelector('.modal').classList.add('show');
    }
    function closeModal(){ backdrop.style.display = 'none'; backdrop.setAttribute('aria-hidden','true'); backdrop.querySelector('.modal').classList.remove('show'); editingId = null; }

    saveBtn.onclick = async ()=>{
      const data = { username: usernameInput.value.trim(), email: emailInput.value.trim(), role: roleInput.value, active: activeInput.value };
      if(passwordInput.value) data.password = passwordInput.value;
      const sel = Array.from(canViewSelect.selectedOptions).map(o=>o.value);
      if(sel.length){ data.can_view = sel.includes('all') ? 'all' : sel.join(','); }
      if(editingId) data.id = editingId;
      const route = editingId ? 'users-update' : 'users-add';
      if(!data.username || !data.email){ showToast('Username & email kh√¥ng ƒë∆∞·ª£c r·ªóng'); return; }
      await apiCall(route, data);
    };
    cancelBtn.onclick = closeModal;

    // open add
    openAdd.onclick = ()=> openModal(null);
    fab.onclick = ()=> openModal(null);

    reload.onclick = ()=> fetchUsers();

    // quick filter
    q.addEventListener('input', debounce(()=>{ const v = q.value.trim().toLowerCase(); const filtered = users.filter(u => (u.username||'').toLowerCase().includes(v) || (u.email||'').toLowerCase().includes(v) || (String(u.created_at||u.created||'')).toLowerCase().includes(v)); renderTable(filtered); }, 200));

    // keyboard shortcuts
    document.addEventListener('keydown', (e)=>{ if(e.key === 'Escape'){ closeModal(); } if(e.ctrlKey && e.key === 'n'){ e.preventDefault(); openModal(null); } });

    // close modal when clicking backdrop
    backdrop.addEventListener('click', (e)=>{ if(e.target === backdrop) closeModal(); });

    // initial load
    fetchUsers();
  </script>
</body>
</html>
