<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Đăng nhập</title>
<style>
    /* ====== Cơ bản ====== */
    :root{
        --blue: #004aad;
        --gold: #ccae6e;
        --bg: #f7f9fb;
        --success: #28a745;
        --error: #dc3545;
    }
    html,body{height:100%; margin:0;}
    body{
        display:flex;
        justify-content:center;
        align-items:center;
        min-height:100vh;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: var(--blue);
        transition: opacity 0.6s ease, transform 0.6s ease;
    }

    /* ====== Container Form ====== */
    .login{
        background: var(--blue);
        padding: 28px 30px;
        border-radius: 12px;
        display:flex;
        flex-direction:column;
        align-items:center;
        width: 360px;
        box-shadow: 2px 4px 6px 8px rgba(19, 19, 19, 0.12);
        transform-origin: center;
        margin: 0 10px;
    }
    .logo{
        width: 84px;
        height: 84px;
        margin-bottom: 6px;
        object-fit:contain;
    }
    form h2{
        text-align:center;
        color: var(--gold);
        font-size:22px;
        margin: 8px 0 14px;
        letter-spacing:0.2px;
    }

    .input-form{ width:100%; margin: 8px 0; }
    .input-form input{
        padding:12px 14px;
        width:100%;
        border-radius:8px;
        border: none;
        background: rgba(204,174,110,0.15);
        color: #fff;
        outline: none;
        box-sizing: border-box;
        font-size:15px;
    }
    .input-form input::placeholder{ color: rgba(255,255,255,0.85); }
    .btn-auth{
        width:100%;
        padding:12px;
        border: none;
        border-radius:8px;
        font-weight:700;
        font-size:16px;
        transition: transform 0.15s ease, opacity 0.2s;
        cursor:pointer;
        margin-top: 10px;
        background: linear-gradient(90deg,#ffd86b,#f5b042);
        color: #08304a;
        display:flex;
        align-items:center;
        justify-content:center;
        gap:8px;
    }
    .btn-auth:active{ transform: translateY(1px); }
    .btn-auth[disabled]{ opacity:0.7; cursor:not-allowed; transform:none; }

    .login p{
       text-align: right;
       color: #fff;
       font-size: 14px;
       width:100%;
       margin: 12px 0 0;
    }
    .login p a{ color: #fff; text-decoration:none; }
    .login p span{
        text-decoration: underline;
        font-weight: 700;
        cursor: pointer;
    }

    /* ====== Toast ====== */
    .toast {
        position: fixed;
        top: -120px;
        left: 50%;
        transform: translateX(-50%);
        padding: 14px 22px;
        border-radius: 10px;
        color: #fff;
        font-size: 15px;
        font-weight: 700;
        opacity: 0;
        transition: top 2.45s cubic-bezier(.2,.9,.2,1), opacity 0.45s;
        z-index: 9999;
        box-shadow: 0 8px 20px rgba(0,0,0,0.12);
    }
    .toast.show { top: 22px; opacity: 1; }
    .toast.success { background: var(--success); }
    .toast.error { background: var(--error); }

    /* ====== Spinner nhỏ trong nút ====== */
    .spinner {
        width:18px;
        height:18px;
        border-radius:50%;
        border: 2px solid rgba(0,0,0,0.1);
        border-top-color: rgba(0,0,0,0.3);
        animation: spin 0.8s linear infinite;
        box-sizing: border-box;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* ====== Fade-out trang khi chuyển ====== */
    .fade-out {
        opacity: 0;
        transform: scale(1.02);
        pointer-events: none;
    }

    /* ====== Shake (rung) khi lỗi ====== */
    @keyframes shake {
        10%, 90% { transform: translateX(-1px); }
        20%, 80% { transform: translateX(2px); }
        30%, 50%, 70% { transform: translateX(-4px); }
        40%, 60% { transform: translateX(4px); }
    }
    .shake {
        animation: shake 0.45s;
    }

    /* ====== Responsive nhỏ ====== */
    @media (max-width:420px){
        .login{ width: 92%; padding:20px; }
        .input-form input{ font-size:14px; padding:10px; }
    }
</style>
</head>
<body>
<!-- Header / Footer placeholder (nếu bạn load riêng) -->
<div id="header"></div>

<!-- Toast thông báo -->
<div id="toast" class="toast" role="status" aria-live="polite"></div>

<!-- Form đăng nhập -->
<div class="login" id="loginBox" aria-labelledby="loginTitle">
    <img src="./img/logo.png" alt="Logo" class="logo">
    <form id="loginForm" novalidate>
        <h2 id="loginTitle">Đăng nhập</h2>

        <div class="input-form">
            <input type="text" placeholder="Tài khoản" id="username" autocomplete="username" required>
        </div>
        <div class="input-form">
            <input type="password" placeholder="Mật khẩu" id="password" autocomplete="current-password" required>
        </div>

        <button type="submit" class="btn-auth" id="btnAuth" aria-live="polite">
            <span id="btnContent">Đăng nhập</span>
        </button>
    </form>

    <p>Bạn chưa có tài khoản?<a href="register.html"><span>Đăng ký</span></a></p>
</div>

<div id="footer"></div>

<script>
/* ========== Cấu hình ========== */
const webAppUrl = "https://script.google.com/macros/s/AKfycbzLQgBPPyVTbLxuQhMJOa5B8v2J7Ckm2qiL_9d__3B96bDcRrbrEpiGIUCVdCwunM52/exec";
const ref = window.location.origin;

// Lấy param redirect nếu có
const params = new URLSearchParams(window.location.search);
const redirectURL = params.get("redirect");

/* ========== DOM ========== */
const loginForm = document.getElementById("loginForm");
const btnAuth = document.getElementById("btnAuth");
const btnContent = document.getElementById("btnContent");
const toastEl = document.getElementById("toast");
const loginBox = document.getElementById("loginBox");
const usernameInput = document.getElementById("username");
const passwordInput = document.getElementById("password");

/* ========== Hàm hiển thị toast ========== */
let toastTimer = null;
function showToast(message, type = "success", duration = 2500) {
    clearTimeout(toastTimer);
    toastEl.textContent = message;
    toastEl.className = `toast ${type} show`;
    // Nếu là lỗi: rung hộp login để nổi bật
    if(type === "error") {
        loginBox.classList.remove("shake");
        // reflow để restart animation
        void loginBox.offsetWidth;
        loginBox.classList.add("shake");
    }
    toastTimer = setTimeout(() => {
        toastEl.classList.remove("show");
    }, duration);
}

/* ========== Helpers: bật/tắt loading trên nút ======== */
function setLoading(isLoading) {
    if(isLoading) {
        btnAuth.disabled = true;
        // thêm spinner
        btnContent.innerHTML = '<span class="spinner" aria-hidden="true"></span><span style="margin-left:6px">Đang xử lý...</span>';
    } else {
        btnAuth.disabled = false;
        btnContent.textContent = "Đăng nhập";
    }
}

/* ========== Xử lý submit ======== */
loginForm.addEventListener("submit", async function(e) {
    e.preventDefault();

    const username = usernameInput.value.trim();
    const password = passwordInput.value.trim();

    if(!username || !password) {
        showToast("Vui lòng nhập đầy đủ thông tin!", "error");
        return;
    }
    setLoading(true);

    try {
        // Gọi Web App để lấy dữ liệu. Gửi ref để Apps Script nhận biết nguồn
        const resp = await fetch(`${webAppUrl}?ref=${encodeURIComponent(ref)}`, { method: "GET" });
        if(!resp.ok){
            throw new Error("Server trả về lỗi: " + resp.status);
        }

        const data = await resp.json();

        // Lấy sheet2Data hoặc các định dạng khác -- bảo toàn an toàn
        const allUsers = Array.isArray(data.sheet2Data) ? data.sheet2Data : (Array.isArray(data) ? data : []);
        console.log("Dữ liệu Sheet2:", allUsers);

        if(!allUsers || allUsers.length === 0){
            showToast("Chưa có tài khoản trong hệ thống!", "error");
            setLoading(false);
            return;
        }

        // So sánh username (không phân biệt hoa thường) và password chính xác
        const user = allUsers.find(u =>
            u.username && u.username.toString().toLowerCase() === username.toLowerCase() &&
            u.password && u.password.toString() === password
        );

        if(user){
            // Thành công
            showToast("Đăng nhập thành công!", "success");

            // Lưu phiên (bạn có thể lưu thêm thông tin user dưới dạng JSON nếu muốn)
            try {
                localStorage.setItem("loggedInUser", username);
            } catch(err) {
                console.warn("Không thể lưu localStorage:", err);
            }

            // Hiệu ứng chuyển trang (fade-out)
            document.body.classList.add("fade-out");

            // Chờ animation rồi chuyển trang
            setTimeout(() => {
                window.location.href = redirectURL || "quanly.html";
            }, 600);

        } else {
            // Thất bại
            showToast("Tài khoản hoặc mật khẩu không đúng!", "error");
            setLoading(false);
        }

    } catch(err) {
        console.error("Lỗi kết nối server:", err);
        showToast("Lỗi kết nối server!", "error");
        setLoading(false);
    }
});

/* ========== Phím Enter cho accessibility: tự submit handled above ========= */
usernameInput.addEventListener("keydown", (e) => {
    if(e.key === "Enter"){
        e.preventDefault();
        passwordInput.focus();
    }
});
passwordInput.addEventListener("keydown", (e) => {
    if(e.key === "Enter"){
        e.preventDefault();
        btnAuth.click();
    }
});

/* ========== Tự hide toast khi click vào nó ========= */
toastEl.addEventListener("click", () => {
    toastEl.classList.remove("show");
});

/* ========== Tự focus ô username khi load ========= */
window.addEventListener("load", () => {
    usernameInput.focus();
});
</script>
</body>
</html>
