<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Th∆∞ vi·ªán s·ªë S∆∞ ƒëo√†n 10</title>
<style>
  :root{
    --primary: #003d82;
    --accent:  #ccae6e;
    --bg: #f4f7fb;
    --card: #ffffff;
    --muted:#6b7280;
    --radius:12px;
    --shadow: 0 10px 30px rgba(16,24,40,0.06);
  }
  html.dark { --bg:#0b1220; --card:#071122; --muted:#9aa6b2; --primary:#1e90ff; --accent:#c7992d; --shadow:0 8px 30px rgba(0,0,0,0.6); color: #e6eef8; }
  *{box-sizing:border-box}
  body{
    margin:0; font-family:Inter, "Segoe UI", Roboto, Arial, sans-serif;
    background: linear-gradient(180deg,var(--bg), #fff 220px);
    color: #0f1724; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    padding:18px; display:flex; justify-content:center;
  }
  .wrap{width:100%;max-width:1200px;display:grid;grid-template-columns:260px 1fr;gap:18px}
  /* SIDEBAR */
  .sidebar{background:linear-gradient(180deg,var(--primary), #00305a); color:#fff;border-radius:var(--radius);padding:18px;box-shadow:var(--shadow);display:flex;flex-direction:column}
  .brand{display:flex;gap:12px;align-items:center}
  .logo{width:52px;height:52px;border-radius:8px;background:var(--accent);display:flex;align-items:center;justify-content:center;color:#042022;font-weight:800;font-size:18px}
  .brand h1{font-size:16px;margin:0}
  .nav{margin-top:16px;display:flex;flex-direction:column;gap:8px}
  .nav a{padding:10px;border-radius:8px;color:inherit;text-decoration:none;font-weight:700;display:flex;gap:8px;align-items:center}
  .nav a:hover, .nav a.active{background:rgba(255,255,255,0.08); transform:translateX(6px)}
  .sidebar .foot{margin-top:auto;display:flex;justify-content:space-between;align-items:center;font-size:13px;color:rgba(255,255,255,0.9)}
  /* HEADER / TOPBAR */
  .main{display:flex;flex-direction:column;gap:12px}
  #header{height:64px;background:var(--card);border-radius:12px;padding:8px 16px;display:flex;align-items:center;justify-content:space-between;box-shadow:var(--shadow)}
  .top-left{display:flex;gap:12px;align-items:center}
  .search{display:flex;align-items:center;gap:8px;background:var(--card);padding:8px;border-radius:10px;box-shadow:var(--shadow);min-width:260px}
  .search input{border:0;outline:0;background:transparent}
  .controls{display:flex;align-items:center;gap:8px}
  .btn{padding:8px 12px;border-radius:8px;border:0;cursor:pointer;font-weight:700}
  .btn.primary{background:var(--primary);color:#fff}
  .btn.ghost{background:transparent;border:1px solid rgba(0,0,0,0.06)}
  .btn.warn{background:#ef4444;color:#fff}
  /* STATS + PANEL */
  .stats{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
  .card{background:var(--card);padding:14px;border-radius:10px;box-shadow:var(--shadow)}
  .k{color:var(--muted);font-size:13px}
  .v{font-size:22px;font-weight:800;margin-top:6px}
  .panel{background:var(--card);padding:16px;border-radius:12px;box-shadow:var(--shadow)}
  table{width:100%;border-collapse:collapse;font-size:14px}
  th,td{padding:10px;border-bottom:1px solid rgba(0,0,0,0.06);text-align:left}
  th{font-weight:800;color:var(--muted);background:transparent}
  .muted{color:var(--muted)}
  /* tabs */
  .tabs{display:flex;gap:8px;margin-bottom:12px}
  .tabBtn{padding:8px 12px;border-radius:8px;background:transparent;border:1px solid rgba(0,0,0,0.04);cursor:pointer;font-weight:700}
  .tabBtn.active{background:var(--primary);color:#fff}
  /* modal & overlay */
  #overlay{position:fixed;inset:0;background:rgba(0,0,0,0.45);display:none;z-index:60}
  .modal{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);background:var(--card);padding:18px;border-radius:12px;box-shadow:0 20px 50px rgba(0,0,0,0.4);width:92%;max-width:820px;z-index:70;display:none}
  .modal h3{margin-bottom:8px}
  .row{display:flex;gap:10px}
  .col{flex:1}
  input[type="text"], input[type="date"], select, textarea{width:100%;padding:10px;border-radius:8px;border:1px solid #ddd}
  textarea{min-height:100px}
  .small{font-size:13px;color:var(--muted)}
  /* PDF viewer styling */
  .pdfWrap{position:relative;background:#fcf8e8;border-radius:8px;overflow:hidden}
  .pdfWrap iframe{width:100%;height:70vh;border:0;display:block}
  .watermarkView{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%) rotate(-12deg);font-size:48px;color:rgba(200,0,0,0.12);pointer-events:none;user-select:none}
  /* chart */
  #chart{width:100%;height:200px;background:transparent}
  /* responsive */
  @media(max-width:980px){
    .wrap{grid-template-columns:1fr;padding:12px}
    .sidebar{position:fixed;left:-320px;top:12px;height:calc(100vh - 24px);z-index:70}
    .sidebar.open{left:12px}
    #openSidebar{display:inline-block}
  }
  @media(max-width:640px){
    .stats{grid-template-columns:repeat(2,1fr)}
  }
  @media(max-width:420px){
    .stats{grid-template-columns:1fr}
    .row{flex-direction:column}
  }
  /* small utilities */
  .muted{color:var(--muted)}
  .empty{padding:20px;text-align:center;color:var(--muted)}
  .actions button{margin-right:6px}
  .card.small { padding:10px }
</style>
</head>
<body>
<div class="wrap">
  <!-- SIDEBAR -->
  <aside class="sidebar" id="sidebar" aria-label="Main navigation">
    <div class="brand">
      <div class="logo"><img style="width: 60px;" src="./img/logo.png" alt=""></div>
      <div>
        <h1>Th∆∞ vi·ªán s·ªë S∆∞ ƒëo√†n 10</h1>
        <div class="small">Tri th·ª©c ƒë·ªìng h√†nh</div>
      </div>
    </div>

    <nav class="nav" role="navigation">
      <a href="#" class="active" data-tab="van-ban">üìÑ VƒÉn b·∫£n</a>
      <a href="#" data-tab="danh-muc">üìö Danh m·ª•c</a>
      <a href="#" data-tab="cai-dat">‚öô C√†i ƒë·∫∑t</a>
    </nav>

    <div class="foot">
      <div>
        <div style="font-weight:800">Admin</div>
        <div class="small">Qu·∫£n tr·ªã vi√™n</div>
      </div>
      <div class="small">5.0</div>
    </div>
  </aside>

  <!-- MAIN -->
  <main class="main">
    <div id="header">
      <div class="top-left">
        <button id="openSidebar" class="btn ghost" style="display:none">‚ò∞</button>
        <div style="display:flex;gap:12px;align-items:center">
          <div class="search"><svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M21 21l-4.35-4.35" stroke="#9aa6b2" stroke-width="1.6" stroke-linecap="round"/></svg><input id="globalSearch" placeholder="T√¨m vƒÉn b·∫£n, s·ªë hi·ªáu, danh m·ª•c..." /></div>
        </div>
      </div>

      <div class="controls">
        <select id="themeColor" title="Ch·ªçn m√†u ch·ªß ƒë·∫°o" class="small" style="padding:8px;border-radius:8px;border:1px solid #ddd">
          <option value="#003d82">Xanh Qu√¢n ƒê·ªôi</option>
          <option value="#00695c">Xanh L√°</option>
          <option value="#4b2e83">T√≠m</option>
          <option value="#b45309">N√¢u V√†ng</option>
        </select>
        <button id="toggleDark" class="btn ghost" title="Dark mode">üåô</button>
        <button id="btnAdd" class="btn primary">+ Th√™m vƒÉn b·∫£n</button>
        <button id="btnExport" class="btn">Export</button>
      </div>
    </div>

    <div class="stats" style="margin-top:8px">
      <div class="card">
        <div class="k">T·ªïng vƒÉn b·∫£n</div>
        <div class="v" id="statDocs">0</div>
        <div class="small">T√†i li·ªáu trong h·ªá th·ªëng</div>
      </div>
      <div class="card">
        <div class="k">Danh m·ª•c</div>
        <div class="v" id="statCats">0</div>
        <div class="small">S·ªë nh√≥m</div>
      </div>
      <div class="card">
        <div class="k">Ho·∫°t ƒë·ªông</div>
        <div class="v">Admin</div>
        <div class="small">Quy·ªÅn ƒë·∫ßy ƒë·ªß</div>
      </div>
    </div>

    <div class="panel" style="margin-top:12px">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <div style="font-weight:800;font-size:18px">Qu·∫£n l√Ω</div>
          <div class="small" id="breadcrumb">VƒÉn b·∫£n</div>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <button class="tabBtn active" data-tab="van-ban">VƒÉn b·∫£n</button>
          <button class="tabBtn" data-tab="danh-muc">Danh m·ª•c</button>
          <button class="tabBtn" data-tab="cai-dat">C√†i ƒë·∫∑t</button>
        </div>
      </div>

      <!-- TAB PANELS -->
      <div id="tabContent" style="margin-top:12px">

        <!-- VƒÇN B·∫¢N -->
        <section id="van-ban" class="tabPanel">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
            <div>
              <div style="font-weight:800">VƒÉn b·∫£n</div>
              <div class="small">Danh s√°ch vƒÉn b·∫£n</div>
            </div>
            <div style="display:flex;gap:8px">
              <input id="filterInput" placeholder="L·ªçc nhanh..." class="small" style="padding:8px;border-radius:8px;border:1px solid #ddd" />
              <button id="openAdd2" class="btn primary">+ Th√™m</button>
            </div>
          </div>

          <div style="overflow:auto">
            <table id="docsTable" aria-label="Danh s√°ch vƒÉn b·∫£n">
              <thead>
                <tr><th style="width:40px">#</th><th>S·ªë hi·ªáu</th><th>Ti√™u ƒë·ªÅ</th><th>Danh m·ª•c</th><th style="width:140px">Ng√†y</th><th style="width:260px">H√†nh ƒë·ªông</th></tr>
              </thead>
              <tbody id="docsTbody"></tbody>
            </table>
            <div id="emptyDocs" class="empty" style="display:none">Ch∆∞a c√≥ vƒÉn b·∫£n. Nh·∫•n "+ Th√™m" ƒë·ªÉ t·∫°o.</div>
          </div>
        </section>

        <!-- DANH M·ª§C -->
        <section id="danh-muc" class="tabPanel" style="display:none">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
            <div><div style="font-weight:800">Danh m·ª•c</div><div class="small">Qu·∫£n l√Ω nh√≥m t√†i li·ªáu</div></div>
            <div style="display:flex;gap:8px"><button id="addCatBtn" class="btn primary">+ Th√™m danh m·ª•c</button><button id="exportCats" class="btn">Export JSON</button></div>
          </div>

          <div id="catsGrid" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px"></div>
        </section>

        <!-- C√ÄI ƒê·∫∂T -->
        <section id="cai-dat" class="tabPanel" style="display:none">
          <div style="display:grid;grid-template-columns:1fr 320px;gap:12px">
            <div>
              <div style="font-weight:800">C√†i ƒë·∫∑t h·ªá th·ªëng</div>
              <div style="margin-top:12px">
                <div style="margin-bottom:8px"><strong>Theme:</strong></div>
                <div style="display:flex;gap:8px;align-items:center">
                  <label class="small">Ch·ªß ƒë·∫°o:</label>
                  <select id="colorSelect"><option value="#003d82">Xanh Qu√¢n ƒë·ªôi</option><option value="#00695c">Xanh l√°</option><option value="#4b2e83">T√≠m</option><option value="#b45309">N√¢u v√†ng</option></select>
                </div>

                <div style="margin-top:12px">
                  <div style="font-weight:700">Backup / Restore</div>
                  <div class="small" style="margin-top:8px">B·∫°n c√≥ th·ªÉ xu·∫•t (backup) to√†n b·ªô d·ªØ li·ªáu ho·∫∑c ph·ª•c h·ªìi t·ª´ file JSON.</div>
                  <div style="display:flex;gap:8px;margin-top:8px">
                    <button id="backupBtn" class="btn">Backup JSON</button>
                    <input type="file" id="restoreInput" accept="application/json" />
                  </div>
                </div>

                <div style="margin-top:12px">
                  <div style="font-weight:700">Import / Export</div>
                  <div style="margin-top:8px"><button id="exportCsvBtn" class="btn">Export CSV</button></div>
                </div>

                <div style="margin-top:12px">
                  <div style="font-weight:700">L∆∞u √Ω PDF</div>
                  <div class="small" style="margin-top:6px">PDF upload s·∫Ω ƒë∆∞·ª£c chuy·ªÉn th√†nh data URL v√† l∆∞u trong tr√¨nh duy·ªát (localStorage). Kh√¥ng l∆∞u file qu√° l·ªõn (d·ªÖ ƒë·∫ßy b·ªô nh·ªõ localStorage).</div>
                </div>
              </div>
            </div>

            <div>
              <div style="font-weight:800">Bi·ªÉu ƒë·ªì</div>
              <canvas id="chart" width="320" height="200" style="margin-top:10px"></canvas>
            </div>
          </div>
        </section>

      </div>
    </div>
  </main>
</div>

<!-- Overlay + Modals -->
<div id="overlay"></div>

<!-- Add / Edit Document Modal -->
<div id="docModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="docModalTitle">
  <h3 id="docModalTitle">Th√™m / S·ª≠a vƒÉn b·∫£n</h3>
  <div class="row">
    <div class="col">
      <label class="small">S·ªë hi·ªáu</label>
      <input id="inpSohieu" type="text" placeholder="S·ªë hi·ªáu..." />
    </div>
    <div class="col">
      <label class="small">Ng√†y ban h√†nh</label>
      <input id="inpDate" type="date" />
    </div>
  </div>
  <div style="margin-top:8px">
    <label class="small">Ti√™u ƒë·ªÅ</label>
    <input id="inpTitle" type="text" placeholder="Ti√™u ƒë·ªÅ..." />
  </div>
  <div style="margin-top:8px">
    <label class="small">Danh m·ª•c</label>
    <select id="inpCategory"></select>
    <div style="display:flex;gap:8px;margin-top:8px">
      <input id="newCatInput" type="text" placeholder="N·∫øu mu·ªën th√™m danh m·ª•c m·ªõi..." class="small" />
      <button id="addCatQuick" class="btn">Th√™m</button>
    </div>
  </div>
  <div style="margin-top:8px">
    <label class="small">Upload PDF (t√πy ch·ªçn; ch√∫ √Ω k√≠ch th∆∞·ªõc)</label>
    <input id="inpPdf" type="file" accept="application/pdf" />
    <div class="small" id="pdfSizeWarn" style="color:#b45309;display:none;margin-top:6px">‚ö† File l·ªõn c√≥ th·ªÉ l√†m ƒë·∫ßy b·ªô nh·ªõ tr√¨nh duy·ªát.</div>
    <div class="small" id="pdfPreview" style="margin-top:8px"></div>
  </div>
  <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
    <button id="btnCancel" class="btn ghost">H·ªßy</button>
    <button id="btnSaveDoc" class="btn primary">L∆∞u</button>
  </div>
</div>

<!-- View Document Modal -->
<div id="viewModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="viewModalTitle">
  <h3 id="viewModalTitle">Xem vƒÉn b·∫£n</h3>
  <div id="viewMeta" class="small muted" style="margin-bottom:8px"></div>
  <div class="pdfWrap">
    <iframe id="pdfFrame" src=""></iframe>
    <div class="watermarkView">Th∆∞ vi·ªán s·ªë</div>
  </div>
  <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
    <button id="btnCloseView" class="btn ghost">ƒê√≥ng</button>
    <a id="downloadPdf" class="btn" download style="display:none">üì• T·∫£i PDF</a>
  </div>
</div>

<script>
/* ====================== C·∫§U H√åNH ====================== */
/*
 - Thay API_URL b·∫±ng URL Google Apps Script Web App (doGet tr·∫£ JSON {status:"ok", data:[{...}]})
 - N·∫øu kh√¥ng c√≥ API_URL ho·∫∑c fetch l·ªói s·∫Ω d√πng d·ªØ li·ªáu m·∫´u (sampleData).
*/
const API_URL = "https://script.google.com/macros/s/YOUR_DEPLOYED_WEB_APP_URL/exec"; // <-- THAY ƒêI
const LOCAL_KEY = "thuvien_docs_v1";

let docs = [];
let categories = [];
let editingIndex = -1; // n·∫øu >=0 l√† s·ª≠a

// D·ªØ li·ªáu m·∫´u (fallback)
const sampleData = [
  {
    "ID":"7",
    "Nh√≥m":"VƒÉn b·∫£n ph√°p lu·∫≠t",
    "STT":"1",
    "S·ªë hi·ªáu":"286/2025/Nƒê-CP",
    "C∆° quan BH":"Ch√≠nh ph·ªß",
    "Ng√†y BH":"2025-11-03",
    "Lo·∫°i":"Ngh·ªã ƒë·ªãnh",
    "Ng∆∞·ªùi k√Ω":"H·ªì ƒê·ª©c Ph·ªõc",
    "Ti√™u ƒë·ªÅ":"Ngh·ªã ƒë·ªãnh 286/2025/Nƒê-CP s·ª≠a ƒë·ªïi c√°c Ngh·ªã ƒë·ªãnh trong qu·∫£n l√Ω s·ª≠ d·ª•ng t√†i s·∫£n c√¥ng",
    "PDF":"https://example.com/a.pdf",
    "·∫¢nh":"https://example.com/image1.jpg",
    "Tr·∫°ng th√°i":"1"
  }
];

/* ====================== H·ªñ TR·ª¢ ƒê·ªäNH D·∫†NG NG√ÄY ====================== */
function toInputDate(v){
  if(!v) return "";
  // ch·∫•p nh·∫≠n ƒë·ªãnh d·∫°ng dd/mm/yyyy ho·∫∑c yyyy-mm-dd
  if(/^\d{2}\/\d{2}\/\d{4}$/.test(v)){
    const [d,m,y]=v.split("/");
    return `${y}-${m}-${d}`;
  }
  if(/^\d{4}-\d{2}-\d{2}$/.test(v)) return v;
  // try Date parse
  const dt = new Date(v);
  if(!isNaN(dt)) {
    const y=dt.getFullYear(), m=("0"+(dt.getMonth()+1)).slice(-2), d=("0"+dt.getDate()).slice(-2);
    return `${y}-${m}-${d}`;
  }
  return "";
}

function formatDateDisplay(v){
  if(!v) return "";
  if(/^\d{4}-\d{2}-\d{2}$/.test(v)){
    const [y,m,d]=v.split("-");
    return `${d}/${m}/${y}`;
  }
  return v;
}

/* ====================== LOAD D·ªÆ LI·ªÜU ====================== */
async function loadSheetData(){
  try {
    // n·∫øu trong localStorage ƒë√£ c√≥ d·ªØ li·ªáu do user ch·ªânh s·ª≠a -> ∆∞u ti√™n
    const local = localStorage.getItem(LOCAL_KEY);
    if(local){
      docs = JSON.parse(local);
      normalizeAndRender();
      return;
    }

    // fetch t·ª´ Web App
    const resp = await fetch(API_URL, {cache: "no-store"});
    if(!resp.ok) throw new Error("fetch error");
    const json = await resp.json();
    if(!json || json.status!=="ok" || !Array.isArray(json.data)) throw new Error("invalid format");

    // chuy·ªÉn d·ªØ li·ªáu theo ƒë·ªãnh d·∫°ng n·ªôi b·ªô
    docs = json.data.map((r, idx) => ({
      id: r["ID"] || (idx+1),
      group: r["Nh√≥m"] || r["Nh√≥m"] || r.group || "",
      stt: r["STT"] || "",
      sohieu: r["S·ªë hi·ªáu"] || r.sohieu || "",
      coquan: r["C∆° quan BH"] || r.coquan || "",
      date: toInputDate(r["Ng√†y BH"] || r.date || ""),
      loai: r["Lo·∫°i"] || "",
      nguoiky: r["Ng∆∞·ªùi k√Ω"] || "",
      tieude: r["Ti√™u ƒë·ªÅ"] || r.title || "",
      pdf: r["PDF"] || r.pdf || "",
      img: r["·∫¢nh"] || r.img || "",
      trangthai: r["Tr·∫°ng th√°i"] || ""
    }));

    normalizeAndRender();
  } catch (e){
    console.warn("Kh√¥ng l·∫•y ƒë∆∞·ª£c t·ª´ API, d√πng d·ªØ li·ªáu m·∫´u.", e);
    docs = sampleData.map((r, idx) => ({
      id: r["ID"] || (idx+1),
      group: r["Nh√≥m"] || "",
      stt: r["STT"] || "",
      sohieu: r["S·ªë hi·ªáu"] || "",
      coquan: r["C∆° quan BH"] || "",
      date: toInputDate(r["Ng√†y BH"] || ""),
      loai: r["Lo·∫°i"] || "",
      nguoiky: r["Ng∆∞·ªùi k√Ω"] || "",
      tieude: r["Ti√™u ƒë·ªÅ"] || "",
      pdf: r["PDF"] || "",
      img: r["·∫¢nh"] || "",
      trangthai: r["Tr·∫°ng th√°i"] || ""
    }));
    normalizeAndRender();
  }
}

function normalizeAndRender(){
  // ƒë·∫£m b·∫£o c√≥ m·∫£ng
  docs = docs || [];
  // categories l√† t·∫≠p h·ª£p c√°c group
  categories = [...new Set(docs.map(d => d.group).filter(Boolean))];
  renderCategories();
  renderDocs();
  updateStats();
  saveLocal(); // l∆∞u l·∫ßn ƒë·∫ßu
  drawChart();
}

/* ====================== L∆ØU / LOAD LOCAL ====================== */
function saveLocal(){
  localStorage.setItem(LOCAL_KEY, JSON.stringify(docs));
}
function clearLocal(){
  localStorage.removeItem(LOCAL_KEY);
}

/* ====================== RENDER DANH S√ÅCH ====================== */
function renderDocs(filterText){
  const tbody = document.getElementById("docsTbody");
  tbody.innerHTML = "";

  const f = (filterText || "").trim().toLowerCase();

  const list = docs.filter(d => {
    if(!f) return true;
    return (d.sohieu || "").toLowerCase().includes(f)
      || (d.tieude || "").toLowerCase().includes(f)
      || (d.group || "").toLowerCase().includes(f)
      || (d.nguoiky || "").toLowerCase().includes(f);
  });

  if(list.length === 0){
    document.getElementById("emptyDocs").style.display = "block";
  } else {
    document.getElementById("emptyDocs").style.display = "none";
  }

  list.forEach((d, i) => {
    const tr = document.createElement("tr");
    const idx = docs.indexOf(d);
    tr.innerHTML = `
      <td>${idx + 1}</td>
      <td>${escapeHtml(d.sohieu)}</td>
      <td>${escapeHtml(d.tieude)}</td>
      <td>${escapeHtml(d.group)}</td>
      <td>${formatDateDisplay(d.date)}</td>
      <td class="actions">
        <button class="btn ghost" data-act="view" data-id="${idx}">Xem</button>
        <button class="btn" data-act="edit" data-id="${idx}">S·ª≠a</button>
        <button class="btn warn" data-act="del" data-id="${idx}">X√≥a</button>
        ${d.pdf ? `<a class="btn" href="${d.pdf}" download target="_blank">T·∫£i</a>` : ""}
      </td>
    `;
    tbody.appendChild(tr);
  });

  // delegation cho c√°c n√∫t h√†nh ƒë·ªông
  tbody.querySelectorAll("button[data-act]").forEach(btn => {
    btn.onclick = (e) => {
      const act = btn.getAttribute("data-act");
      const id = Number(btn.getAttribute("data-id"));
      if(act === "view") openView(id);
      else if(act === "edit") openEdit(id);
      else if(act === "del") deleteDoc(id);
    };
  });
}

/* ====================== ESCAPE HTML SAFE ====================== */
function escapeHtml(s){ return (s||"").toString().replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

/* ====================== VIEW ====================== */
function openView(index){
  const d = docs[index];
  if(!d) return;
  document.getElementById("viewMeta").textContent = `${d.sohieu || ""} ‚Ä¢ ${formatDateDisplay(d.date) || ""} ‚Ä¢ ${d.group || ""}`;
  const pdfFrame = document.getElementById("pdfFrame");
  pdfFrame.src = d.pdf || "";

  const dl = document.getElementById("downloadPdf");
  if(d.pdf){
    dl.href = d.pdf;
    dl.style.display = "inline-block";
  } else {
    dl.style.display = "none";
  }

  openModal("viewModal");
}

/* ====================== TH√äM / S·ª¨A ====================== */
function openAdd(){
  editingIndex = -1;
  document.getElementById("docModalTitle").textContent = "Th√™m vƒÉn b·∫£n";
  document.getElementById("inpSohieu").value = "";
  document.getElementById("inpDate").value = "";
  document.getElementById("inpTitle").value = "";
  document.getElementById("inpCategory").value = "";
  document.getElementById("pdfPreview").innerHTML = "";
  document.getElementById("pdfSizeWarn").style.display = "none";
  document.getElementById("inpPdf").value = "";
  populateCategorySelect();
  openModal("docModal");
}

function openEdit(index){
  const d = docs[index];
  if(!d) return;
  editingIndex = index;
  document.getElementById("docModalTitle").textContent = "S·ª≠a vƒÉn b·∫£n";
  document.getElementById("inpSohieu").value = d.sohieu || "";
  document.getElementById("inpDate").value = d.date || "";
  document.getElementById("inpTitle").value = d.tieude || "";
  populateCategorySelect();
  document.getElementById("inpCategory").value = d.group || "";
  document.getElementById("pdfPreview").innerHTML = d.pdf ? `<small>PDF hi·ªán c√≥: <a href="${d.pdf}" target="_blank">M·ªü</a></small>` : "";
  document.getElementById("pdfSizeWarn").style.display = "none";
  document.getElementById("inpPdf").value = "";
  openModal("docModal");
}

function deleteDoc(index){
  if(!confirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a vƒÉn b·∫£n n√†y?")) return;
  docs.splice(index,1);
  categories = [...new Set(docs.map(d => d.group).filter(Boolean))];
  saveLocal();
  renderCategories();
  renderDocs(document.getElementById("filterInput").value);
  updateStats();
  drawChart();
}

/* ====================== MODAL ====================== */
function openModal(id){
  document.getElementById("overlay").style.display = "block";
  document.getElementById(id).style.display = "block";
}
function closeModal(id){
  document.getElementById("overlay").style.display = "none";
  document.getElementById(id).style.display = "none";
}

/* ====================== SAVE DOCUMENT (ADD / EDIT) ====================== */
async function handleSaveDoc(){
  const sohieu = document.getElementById("inpSohieu").value.trim();
  const date = document.getElementById("inpDate").value;
  const title = document.getElementById("inpTitle").value.trim();
  let category = document.getElementById("inpCategory").value.trim();
  const newCat = document.getElementById("newCatInput").value.trim();

  if(newCat){
    category = newCat;
    if(!categories.includes(category)) categories.push(category);
  }

  // l·∫•y file pdf (n·∫øu c√≥ m·ªõi upload)
  const fileInput = document.getElementById("inpPdf");
  let pdfData = null;
  if(fileInput.files && fileInput.files.length){
    const f = fileInput.files[0];
    // c·∫£nh b√°o l·ªõn > 2MB
    if(f.size > 2 * 1024 * 1024){
      document.getElementById("pdfSizeWarn").style.display = "block";
    } else document.getElementById("pdfSizeWarn").style.display = "none";

    pdfData = await fileToDataUrl(f);
  }

  if(editingIndex >= 0){
    // s·ª≠a
    const d = docs[editingIndex];
    d.sohieu = sohieu;
    d.date = date;
    d.tieude = title;
    d.group = category;
    if(pdfData) d.pdf = pdfData;
  } else {
    // th√™m m·ªõi
    const newDoc = {
      id: Date.now().toString(),
      group: category,
      stt: (docs.length + 1).toString(),
      sohieu,
      coquan: "",
      date,
      loai: "",
      nguoiky: "",
      tieude: title,
      pdf: pdfData || "",
      img: "",
      trangthai: "1"
    };
    docs.push(newDoc);
  }

  // c·∫≠p nh·∫≠t danh m·ª•c, l∆∞u local r·ªìi ƒë√≥ng modal
  categories = [...new Set(docs.map(d => d.group).filter(Boolean))];
  saveLocal();
  renderCategories();
  renderDocs(document.getElementById("filterInput").value);
  updateStats();
  drawChart();
  closeModal("docModal");
}

/* ====================== FILE -> DATA URL ====================== */
function fileToDataUrl(file){
  return new Promise((res, rej) => {
    const reader = new FileReader();
    reader.onload = () => res(reader.result);
    reader.onerror = (e) => rej(e);
    reader.readAsDataURL(file);
  });
}

/* ====================== CATEGORIES ====================== */
function renderCategories(){
  const grid = document.getElementById("catsGrid");
  grid.innerHTML = "";

  categories.forEach(cat => {
    const count = docs.filter(d => d.group === cat).length;
    const div = document.createElement("div");
    div.className = "card";
    div.innerHTML = `<div style="font-weight:700">${escapeHtml(cat)}</div><div class="small">${count} vƒÉn b·∫£n</div>`;
    grid.appendChild(div);
  });
}

function populateCategorySelect(){
  const sel = document.getElementById("inpCategory");
  sel.innerHTML = "";
  categories.forEach(c => {
    const opt = document.createElement("option");
    opt.value = c;
    opt.textContent = c;
    sel.appendChild(opt);
  });
}

/* ====================== BACKUP / RESTORE / EXPORT CSV ====================== */
function backupJson(){
  const dataStr = JSON.stringify(docs, null, 2);
  const blob = new Blob([dataStr], {type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = `thuvien_backup_${new Date().toISOString().slice(0,10)}.json`;
  a.click();
}

function restoreJson(file){
  const reader = new FileReader();
  reader.onload = (e) => {
    try{
      const arr = JSON.parse(e.target.result);
      if(!Array.isArray(arr)) throw new Error("Kh√¥ng ph·∫£i JSON h·ª£p l·ªá");
      docs = arr;
      categories = [...new Set(docs.map(d => d.group).filter(Boolean))];
      saveLocal();
      renderCategories();
      renderDocs();
      updateStats();
      drawChart();
      alert("Ph·ª•c h·ªìi th√†nh c√¥ng.");
    } catch(err){
      alert("File kh√¥ng h·ª£p l·ªá: " + err.message);
    }
  };
  reader.readAsText(file);
}

function exportCsv(){
  if(docs.length === 0) { alert("Kh√¥ng c√≥ d·ªØ li·ªáu"); return; }
  const keys = ["id","group","stt","sohieu","coquan","date","loai","nguoiky","tieude","pdf","img","trangthai"];
  const lines = [keys.join(",")];
  docs.forEach(d => {
    const row = keys.map(k => {
      let v = d[k] || "";
      v = v.toString().replace(/"/g,'""');
      return `"${v}"`;
    }).join(",");
    lines.push(row);
  });
  const blob = new Blob([lines.join("\n")], {type:"text/csv;charset=utf-8;"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = `thuvien_export_${new Date().toISOString().slice(0,10)}.csv`;
  a.click();
}

/* ====================== CHART (ƒë∆°n gi·∫£n) ====================== */
function drawChart(){
  const canvas = document.getElementById("chart");
  if(!canvas) return;
  const ctx = canvas.getContext("2d");
  const counts = categories.map(c => docs.filter(d => d.group === c).length);
  // clear
  ctx.clearRect(0,0,canvas.width, canvas.height);
  if(categories.length === 0) {
    ctx.fillStyle = "#999";
    ctx.fillText("Ch∆∞a c√≥ d·ªØ li·ªáu bi·ªÉu ƒë·ªì", 10, 20);
    return;
  }
  const max = Math.max(...counts,1);
  const padding = 30;
  const w = canvas.width - padding*2;
  const h = canvas.height - padding*2;
  const barW = Math.max(12, w / counts.length * 0.6);

  categories.forEach((c,i) => {
    const x = padding + i * (w / counts.length) + ( (w / counts.length) - barW)/2;
    const barH = (counts[i]/max) * (h - 20);
    const y = canvas.height - padding - barH;
    // draw bar
    ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--primary') || "#003d82";
    ctx.fillRect(x, y, barW, barH);
    // label
    ctx.fillStyle = "#333";
    ctx.font = "11px Arial";
    ctx.textAlign = "center";
    ctx.fillText(counts[i], x + barW/2, y - 6);
    ctx.fillText(c, x + barW/2, canvas.height - padding + 14);
  });
}

/* ====================== THEME / DARK MODE ====================== */
function applyTheme(color){
  document.documentElement.style.setProperty("--primary", color);
}
function toggleDark(){
  document.documentElement.classList.toggle("dark");
  localStorage.setItem("theme_dark", document.documentElement.classList.contains("dark") ? "1" : "0");
}
function initTheme(){
  const savedColor = localStorage.getItem("theme_color");
  if(savedColor) {
    document.getElementById("themeColor").value = savedColor;
    applyTheme(savedColor);
  }
  const dark = localStorage.getItem("theme_dark");
  if(dark === "1") document.documentElement.classList.add("dark");
}

/* ====================== HELPER: DOWNLOAD UTILITY ====================== */
function downloadUrl(url, filename){
  const a = document.createElement("a");
  a.href = url;
  a.download = filename || "";
  a.target = "_blank";
  a.click();
}

/* ====================== UI BINDINGS ====================== */
function bindUI(){
  // tabs
  document.querySelectorAll(".nav a").forEach(a => {
    a.onclick = (e) => {
      e.preventDefault();
      document.querySelectorAll(".nav a").forEach(x => x.classList.remove("active"));
      a.classList.add("active");
      const tab = a.getAttribute("data-tab");
      showTab(tab);
    };
  });
  document.querySelectorAll(".tabBtn").forEach(btn => {
    btn.onclick = () => {
      document.querySelectorAll(".tabBtn").forEach(b => b.classList.remove("active"));
      btn.classList.add("active");
      showTab(btn.getAttribute("data-tab"));
    };
  });

  document.getElementById("openAdd2").onclick = openAdd;
  document.getElementById("btnAdd").onclick = openAdd;
  document.getElementById("btnCancel").onclick = () => closeModal("docModal");
  document.getElementById("btnSaveDoc").onclick = handleSaveDoc;

  document.getElementById("addCatQuick").onclick = () => {
    const v = document.getElementById("newCatInput").value.trim();
    if(!v) return alert("Nh·∫≠p t√™n danh m·ª•c");
    if(!categories.includes(v)) categories.push(v);
    populateCategorySelect();
    document.getElementById("newCatInput").value = "";
    renderCategories();
  };

  // search & filter
  const filterInput = document.getElementById("filterInput");
  const globalSearch = document.getElementById("globalSearch");
  function doFilter(){
    const f = (filterInput.value || "") + " " + (globalSearch.value || "");
    renderDocs(f);
  }
  let debounceTimer;
  [filterInput, globalSearch].forEach(el => {
    el.addEventListener("input", () => {
      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(doFilter, 220);
    });
  });

  // pdf input preview
  document.getElementById("inpPdf").addEventListener("change", (e) => {
    const f = e.target.files[0];
    if(!f) { document.getElementById("pdfPreview").innerHTML = ""; return; }
    if(f.size > 2*1024*1024) document.getElementById("pdfSizeWarn").style.display = "block";
    else document.getElementById("pdfSizeWarn").style.display = "none";
    document.getElementById("pdfPreview").innerHTML = `<small>Ch·ªçn file: ${f.name} (${Math.round(f.size/1024)} KB)</small>`;
  });

  // backup / restore / export csv
  document.getElementById("backupBtn").onclick = backupJson;
  document.getElementById("restoreInput").addEventListener("change", (e) => {
    const f = e.target.files[0];
    if(f) restoreJson(f);
  });
  document.getElementById("exportCsvBtn").onclick = exportCsv;
  document.getElementById("exportCats").onclick = () => {
    const blob = new Blob([JSON.stringify(categories,null,2)], {type:"application/json"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = `categories_${new Date().toISOString().slice(0,10)}.json`;
    a.click();
  };

  // chart refresh on resize
  window.addEventListener("resize", () => { drawChart(); });

  // theme handlers
  document.getElementById("themeColor").addEventListener("change", (e) => {
    const c = e.target.value;
    localStorage.setItem("theme_color", c);
    applyTheme(c);
  });
  document.getElementById("toggleDark").addEventListener("click", () => {
    toggleDark();
    drawChart();
  });

  // close view modal
  document.getElementById("btnCloseView").onclick = () => closeModal("viewModal");
  document.getElementById("overlay").onclick = () => {
    closeModal("docModal");
    closeModal("viewModal");
  };

  // docs table delegation (works after render)
}

/* ====================== HELPER: SHOW TAB ====================== */
function showTab(tab){
  document.querySelectorAll(".tabPanel").forEach(p => p.style.display = "none");
  const panel = document.getElementById(tab);
  if(panel) panel.style.display = "block";
  document.getElementById("breadcrumb").textContent = tab === "van-ban" ? "VƒÉn b·∫£n" : (tab === "danh-muc" ? "Danh m·ª•c" : "C√†i ƒë·∫∑t");
}

/* ====================== STATS ====================== */
function updateStats(){
  document.getElementById("statDocs").textContent = docs.length;
  document.getElementById("statCats").textContent = categories.length;
}

/* ====================== INIT ====================== */
(function init(){
  bindUI();
  initTheme();
  loadSheetData();
  // expose some functions for inline buttons created after render
  window.openView = openView;
  window.openEdit = openEdit;
  window.deleteDoc = deleteDoc;
  // save on unload
  window.addEventListener("beforeunload", () => saveLocal());
})();
</script>
</body>
</html>
