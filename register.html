<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <link rel="shortcut icon" href="./img/logo.png" type="image/x-icon">
<title>Đăng ký tài khoản</title>

<!-- ============================
   CSS gốc (giữ nguyên, không thay đổi)
   ============================ -->
<style>
:root{
    --primary:#004aad;
    --secondary:#f5b042;
    --success:#28a745;
    --error:#dc3545;
    --bg:#f0f4f8;
    --input-bg:#ffffffcc;
    --text-dark:#08304a;
}

/* Reset cơ bản */
*{box-sizing:border-box;margin:0;padding:0;font-family:'Segoe UI',sans-serif;}
body{height:100vh; display:flex; justify-content:center; align-items:center; background:var(--bg);}

/* Card đăng ký */
.register-card{
    background:#fff;
    padding:40px 30px;
    border-radius:16px;
    width:360px;
    box-shadow:0 10px 25px rgba(0,0,0,0.1);
    text-align:center;
    transition: transform 0.4s ease, opacity 0.4s ease, filter 0.4s ease;
    opacity:0;
    transform: translateY(20px);
}
.register-card.show{
    opacity:1;
    transform: translateY(0);
}
.register-card:hover{transform: translateY(-5px);}
.register-card h2{
    margin-bottom:24px;
    color:var(--primary);
    font-size:28px;
}
.input-group{margin-bottom:16px; text-align:left;}
.input-group input{
    width:100%;
    padding:14px;
    border-radius:8px;
    border:1px solid #ccc;
    background:var(--input-bg);
    font-size:16px;
    color:var(--text-dark);
    transition: border 0.3s;
}
.input-group input:focus{border-color:var(--primary); outline:none;}
.btn-auth{
    width:100%;
    padding:14px;
    border:none;
    border-radius:10px;
    font-weight:700;
    font-size:16px;
    cursor:pointer;
    background:linear-gradient(90deg,var(--secondary),#ffd86b);
    color:var(--text-dark);
    transition: transform 0.2s, box-shadow 0.2s;
}
.btn-auth:hover{transform: translateY(-2px); box-shadow:0 4px 12px rgba(0,0,0,0.15);}
.register-footer{
    margin-top:18px;
    font-size:14px;
    color:#555;
}
.register-footer a{color:var(--primary); text-decoration:none; font-weight:600;}
.register-footer a:hover{text-decoration:underline;}

/* Toast */
.toast{
    position:fixed;
    top:-120px;
    left:50%;
    transform:translateX(-50%);
    padding:16px 28px;
    border-radius:12px;
    color:#fff;
    font-weight:700;
    opacity:0;
    transition:top 0.45s, opacity 0.45s;
    z-index:9999;
    font-size:14px;
}
.toast.show{top:22px; opacity:1;}
.toast.success{background:var(--success);}
.toast.error{background:var(--error);}
.spinner{
    width:18px;
    height:18px;
    border-radius:50%;
    border:2px solid rgba(255,255,255,0.3);
    border-top-color:#fff;
    animation:spin 0.8s linear infinite;
}
@keyframes spin{to{transform:rotate(360deg);}}

/* Thông báo đăng ký khóa */
.disabled-message{
    font-size:16px;
    color:var(--error);
    font-weight:600;
    margin-top:20px;
}

/* Overlay loading nâng cấp */
#overlayLoading {
    position: fixed;
    top:0; left:0;
    width:100%; height:100%;
    background:rgba(255,255,255,0.85);
    backdrop-filter: blur(4px);
    display:flex;
    justify-content:center;
    align-items:center;
    z-index:9998;
    transition: opacity 0.3s;
    flex-direction: column;
}
#overlayLoading.hidden {
    opacity:0;
    pointer-events:none;
}
.overlay-content{
    text-align:center;
    display:flex;
    flex-direction:column;
    gap:12px;
    align-items:center;
}
.overlay-content .spinner {
    width:40px;
    height:40px;
    border:4px solid rgba(0,0,0,0.1);
    border-top-color:var(--primary);
    border-radius:50%;
    animation: spin 1s linear infinite;
}
.overlay-content .dots {
    display:flex;
    gap:6px;
    margin-top:6px;
}
.overlay-content .dots span {
    display:block;
    width:10px;
    height:10px;
    background:var(--primary);
    border-radius:50%;
    animation: dotsBounce 1.2s infinite ease-in-out;
}
.overlay-content .dots span:nth-child(2){animation-delay:0.2s;}
.overlay-content .dots span:nth-child(3){animation-delay:0.4s;}
.overlay-content .loading-text {
    font-size:16px;
    font-weight:600;
    color:var(--primary);
    animation: textPulse 1.5s infinite;
}
@keyframes dotsBounce {
  0%, 80%, 100% { transform: scale(0); }
  40% { transform: scale(1); }
}
@keyframes textPulse {
  0%,100%{opacity:0.6;}
  50%{opacity:1;}
}

/* ======= thêm vài style nhỏ cho OTP/UI ======= */
.row { display:flex; gap:8px; align-items:center; }
.small-btn {
  padding:10px 12px;
  border-radius:8px;
  border:none;
  background:var(--primary);
  color:#fff;
  cursor:pointer;
  font-weight:600;
}
.small-btn[disabled]{opacity:0.6;cursor:not-allowed;}
.countdown { font-size:13px;color:var(--primary);font-weight:600;margin-left:6px; }
</style>

<!-- EmailJS SDK (dùng để gửi email từ client) -->
<script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
<script>
  /* INIT EmailJS: giữ public key bạn đã khai báo */
  (function(){
    emailjs.init('aL-gGjOA0UWePMm7O'); // <-- public key (giữ nguyên)
  })();
</script>

</head>
<body>

<!-- Overlay loading -->
<div id="overlayLoading">
  <div class="overlay-content">
    <div class="spinner"></div>
    <div class="dots">
      <span></span><span></span><span></span>
    </div>
    <div class="loading-text">Đang kiểm tra trạng thái đăng ký...</div>
  </div>
</div>

<div id="toast" class="toast"></div>

<div class="register-card">
    <img style="width: 120px;" src="./img/logo.png" alt="">
    <h2>Đăng ký tài khoản</h2>

    <!-- Form đăng ký (đã thêm email + otp) -->
    <form id="registerForm" style="display:none;">

        <!-- Email (gửi OTP) -->
        <div class="input-group">
            <input type="email" id="email" placeholder="Email (nhận OTP)" required>
        </div>

        <!-- Gửi OTP + countdown -->
        <div class="input-group row" style="margin-bottom:12px;">
            <button type="button" id="btnSendOtp" class="small-btn">Gửi mã OTP</button>
            <div id="otpStatus" style="flex:1; text-align:left;">
              <span id="otpHint" style="color:#666;font-size:13px;">Bạn sẽ nhận mã trong email.</span>
              <span id="countdown" class="countdown" style="display:none;"></span>
            </div>
        </div>

        <!-- Nhập OTP -->
        <div class="input-group">
            <input type="text" id="otp" placeholder="Nhập mã OTP (6 chữ số)">
        </div>

        <!-- Tên tài khoản -->
        <div class="input-group">
            <input type="text" id="username" placeholder="Tài khoản" required>
        </div>
        <div class="input-group">
            <input type="password" id="password" placeholder="Mật khẩu" required>
        </div>
        <div class="input-group">
            <input type="password" id="password2" placeholder="Nhập lại mật khẩu" required>
        </div>
        <button type="submit" class="btn-auth" id="btnAuth">Tạo tài khoản</button>
    </form>

    <!-- Thông báo đăng ký khóa -->
    <div id="registrationClosed" class="disabled-message" style="display:none;">
        Đăng ký hiện đang tạm khóa. Vui lòng liên hệ admin.
    </div>

    <div class="register-footer">
        Đã có tài khoản? <a href="index.html">Đăng nhập</a>
    </div>
</div>

<script>
/*
  FULL JS A–Z (ĐỒNG BỘ VỚI APPS SCRIPT)
  - Gửi OTP qua EmailJS (client)
  - Lưu OTP + email + expiry vào localStorage
  - Giới hạn gửi lại (cooldown 60s)
  - Verify OTP trước khi gọi API register
  - Gọi API bằng GET ?route=register&username=...&password=...&email=...
  - Client hash password bằng SHA-256 để backend so sánh trực tiếp (backend lưu password đã hash)
*/

/* ================== CẤU HÌNH (bạn có thể thay nếu cần) ================== */
const EMAILJS_SERVICE_ID = "service_tif4jt4";   // <-- thay nếu cần
const EMAILJS_TEMPLATE_ID = "template_sia2iwe"; // <-- thay nếu cần

// API Apps Script (PHẢI TRÙNG VỚI DEPLOY URL CỦA BẠN)
const API = "https://script.google.com/macros/s/AKfycbwuTB_4rOY_mX9S90793Qu55pVLLOdzwsiR7jEYNlRVVMbZDj2G0MU0b2F3OAg0KUuK/exec";

/* ================== UI Elements ================== */
const registerForm = document.getElementById("registerForm");
const btnAuth = document.getElementById("btnAuth");
const toastEl = document.getElementById("toast");
const registrationClosedEl = document.getElementById("registrationClosed");
const overlay = document.getElementById("overlayLoading");
const registerCard = document.querySelector(".register-card");

const btnSendOtp = document.getElementById("btnSendOtp");
const emailInput = document.getElementById("email");
const otpInput = document.getElementById("otp");
const countdownEl = document.getElementById("countdown");
const otpHint = document.getElementById("otpHint");

let REGISTRATION_OPEN = false;

/* ================== TOAST ================== */
function showToast(msg,type="success",duration=2500){
    toastEl.textContent = msg;
    toastEl.className = `toast ${type} show`;
    setTimeout(()=>toastEl.className='toast',duration);
}

/* ================== Loading nút ================== */
function setLoading(isLoading){
    btnAuth.disabled = isLoading;
    btnAuth.innerHTML = isLoading ? '<span class="spinner"></span> Đang xử lý...' : 'Tạo tài khoản';
}

/* ================== SHA-256 hash password (client) ================== */
async function hashPassword(password){
    const encoder = new TextEncoder();
    const data = encoder.encode(password.trim());
    const hashBuffer = await crypto.subtle.digest("SHA-256", data);
    return Array.from(new Uint8Array(hashBuffer)).map(b=>b.toString(16).padStart(2,"0")).join("");
}

/* ================== KIỂM TRA SETTINGS (để mở/khóa đăng ký) ==================
   API trả về cấu trúc data.matkhauopen (mảng) theo Apps Script ở server.
   Hỗ trợ các kiểu trả về khác nhau.
*/
async function checkRegistrationStatus(){
    try{
        const resp = await fetch(`${API}?route=settings`);
        const data = await resp.json();

        // Nhiều biến thể: server có thể trả { status:"success", data: { matkhauopen: [ { key, value } ] } }
        // hoặc những cấu trúc khác — chúng ta cố gắng lấy matkhauopen an toàn.
        let itemObj = null;
        if(data && data.data && data.data.matkhauopen && Array.isArray(data.data.matkhauopen) && data.data.matkhauopen.length){
            itemObj = data.data.matkhauopen[0];
        } else if(data && data.matkhauopen && Array.isArray(data.matkhauopen) && data.matkhauopen.length){
            itemObj = data.matkhauopen[0];
        } else if(data && data.data && data.data.settings && Array.isArray(data.data.settings) && data.data.settings.length){
            itemObj = data.data.settings.find(x => x.key === "registration_open") || null;
        }

        // mặc định false
        REGISTRATION_OPEN = false;
        if(itemObj){
            const k = (itemObj.key || itemObj.Key || "").toString().trim().toLowerCase();
            const v = (itemObj.value || itemObj.Value || itemObj.val || "").toString().trim().toLowerCase();
            if(k === "registration_open" && (v === "true" || v === "1" || v === "yes")) REGISTRATION_OPEN = true;
        }

        overlay.classList.add("hidden");
        registerCard.classList.add("show");

        if(!REGISTRATION_OPEN){
            registerForm.style.display = "none";
            registrationClosedEl.style.display = "block";
        } else {
            registerForm.style.display = "block";
            registrationClosedEl.style.display = "none";
        }
    } catch(err){
        console.error("checkRegistrationStatus error:", err);
        // nếu lỗi — để an toàn: hiện form để admin test (hoặc bạn muốn khóa, thay đổi ở đây)
        overlay.classList.add("hidden");
        registerCard.classList.add("show");
        // mặc định khóa để tránh spam nếu server unreachable
        registerForm.style.display = "none";
        registrationClosedEl.style.display = "block";
        showToast("Không thể kiểm tra trạng thái đăng ký (lỗi server)", "error", 3500);
    }
}
checkRegistrationStatus();

/* ================== OTP LOGIC (localStorage) ==================
   Storage keys:
     otp_email -> JSON { otp, email, exp }
     otp_last_sent_at -> timestamp ms (for cooldown)
======================================================================== */

function saveOtpToLocal(email, otp){
    const payload = { otp: otp, email: email, exp: Date.now() + 5*60*1000 }; // 5 phút
    localStorage.setItem('otp_email', JSON.stringify(payload));
    localStorage.setItem('otp_last_sent_at', String(Date.now()));
}

function getOtpFromLocal(){
    const s = localStorage.getItem('otp_email');
    if(!s) return null;
    try{ return JSON.parse(s); } catch(e){ return null; }
}
function clearOtpLocal(){ localStorage.removeItem('otp_email'); }

/* ================== COOLDOWN ================== */
function getLastSentAt(){ const v = localStorage.getItem('otp_last_sent_at'); return v ? Number(v) : 0; }
function canSendAgain(cooldownSec = 60){
    const last = getLastSentAt();
    return (Date.now() - last) > cooldownSec*1000;
}
let countdownTimer = null;
function startCooldown(seconds = 60){
    const end = Date.now() + seconds*1000;
    countdownEl.style.display = 'inline-block';
    btnSendOtp.disabled = true;
    updateCountdown();

    function updateCountdown(){
        const left = Math.max(0, Math.ceil((end - Date.now())/1000));
        countdownEl.textContent = `Gửi lại sau ${left}s`;
        if(left <= 0){
            clearInterval(countdownTimer);
            countdownEl.style.display = 'none';
            btnSendOtp.disabled = false;
            countdownEl.textContent = '';
        }
    }
    updateCountdown();
    countdownTimer = setInterval(updateCountdown, 900);
}

/* ================== SEND OTP via EmailJS ==================
   EmailJS: template should accept variables:
    - to_email
    - otp_code
    - passcode
    - time
*/
btnSendOtp.addEventListener('click', async ()=>{
    const email = emailInput.value.trim();
    if(!email) { showToast('Nhập email để nhận OTP','error'); return; }

    if(!canSendAgain(60)){ showToast('Vui lòng chờ trước khi gửi lại','error'); return; }

    // tạo OTP 6 chữ số
    const otp = String(Math.floor(100000 + Math.random()*900000));
    const expiryTime = new Date(Date.now() + 5*60*1000); // 5 phút
    const expiryText = expiryTime.toLocaleString('vi-VN');

    // Lưu local (trước khi gửi để verify email trùng)
    saveOtpToLocal(email, otp);

    // Gọi EmailJS - gửi nhiều biến để template nhận được
    try{
        btnSendOtp.disabled = true;
        btnSendOtp.textContent = 'Đang gửi...';
        const templateParams = {
            to_email: email,
            otp_code: otp,
            passcode: otp, // thêm nữa cho template dùng passcode
            time: expiryText
        };

        console.log('Sending EmailJS with params:', templateParams);

        const res = await emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, templateParams);
        console.log('EmailJS response:', res);
        // EmailJS trả về response object; coi là success
        showToast('OTP đã gửi đến email', 'success', 3000);
        startCooldown(60);
        otpHint.textContent = 'Kiểm tra hộp thư (Spam nếu không thấy). OTP hết hạn sau 5 phút.';
        btnSendOtp.textContent = 'Gửi mã OTP';
    }catch(err){
        console.error('EmailJS error', err);
        if(err && err.status === 422){
            console.error('EmailJS 422 response text:', err.text || err);
        }
        showToast('Gửi OTP thất bại', 'error', 3000);
        btnSendOtp.disabled = false;
        btnSendOtp.textContent = 'Gửi mã OTP';
    }
});

/* ================== VERIFY OTP (local) ================== */
function verifyOtpLocal(email, otp){
    const record = getOtpFromLocal();
    if(!record) return { ok:false, msg:'Chưa gửi OTP' };
    if(record.email !== email) return { ok:false, msg:'Email không khớp với OTP đã gửi' };
    if(Date.now() > record.exp) return { ok:false, msg:'OTP đã hết hạn' };
    if(record.otp !== otp) return { ok:false, msg:'OTP không đúng' };
    return { ok:true };
}

/* ================== REGISTER (gọi API nếu OTP hợp lệ) ================== */
registerForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    if (!REGISTRATION_OPEN){
        showToast('Đăng ký hiện đang tạm khóa','error'); return;
    }

    const email = emailInput.value.trim();
    const otp = otpInput.value.trim();
    const username = document.getElementById('username').value.trim();
    const password = document.getElementById('password').value;
    const password2 = document.getElementById('password2').value;

    // Kiểm tra dữ liệu
    if (!email || !otp || !username || !password || !password2) {
        showToast('Nhập đầy đủ thông tin', 'error');
        return;
    }

    if (password !== password2) {
        showToast('Mật khẩu không trùng khớp', 'error');
        return;
    }

    // Verify OTP local
    const otpCheck = verifyOtpLocal(email, otp);
    if (!otpCheck.ok) {
        showToast(otpCheck.msg || 'OTP không hợp lệ', 'error');
        return;
    }

    // OTP hợp lệ -> tiến hành register
    setLoading(true);

    try {
        // hash password client-side (server expects client hash)

        // Build GET URL (Apps Script expects route=register&username=...&password=...&email=...)
        const url =
            `${API}?route=register` +
            `&username=${encodeURIComponent(username)}` +
            `&password=${encodeURIComponent(password)}` +
            `&email=${encodeURIComponent(email)}`;

        const resp = await fetch(url, { method: "GET" });
        const data = await resp.json();

        // server có thể trả { status:"success", userId:..., message:... } hoặc { status:"error", message:... }
        const ok = (data && (data.status === "success" || data.success === true));
        if(ok){
            showToast(data.message || 'Đăng ký thành công!', 'success', 2000);
            // Clear OTP sau khi đăng ký thành công
            clearOtpLocal();
            // Redirect sau 1.5s
            setTimeout(()=> window.location.href = 'index.html', 1500);
            return;
        }

        // handle specific errors
        const msg = data.message || data.error || "Đăng ký thất bại";
        showToast(msg, "error", 3500);
    } catch (err) {
        console.error('Lỗi register:', err);
        showToast('Lỗi server', 'error', 3500);
    } finally {
        setLoading(false);
    }
});

/* ================== Optional: clear expired OTP periodically ================== */
setInterval(()=> {
    const rec = getOtpFromLocal();
    if(rec && Date.now() > rec.exp) clearOtpLocal();
}, 30*1000);

</script>

</body>
</html>
