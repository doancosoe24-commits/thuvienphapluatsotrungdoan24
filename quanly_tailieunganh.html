<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Admin - T√†i li·ªáu ng√†nh (Qu·∫£n l√Ω quy·ªÅn)</title>
<link rel="shortcut icon" href="./img/logo.png" type="image/x-icon">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#eef6ff;
  --card:#ffffff;
  --text:#0f172a;
  --accent:#0b6cff;
  --accent-2:#06b6d4;
  --muted:#6b7280;
  --radius:12px;
  --shadow-sm:0 8px 24px rgba(7,16,36,0.06);
  --shadow-lg:0 22px 60px rgba(7,16,36,0.10);
  --danger:#ef4444;
  --success:#10b981;
  font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial;
}

/* base */
*{box-sizing:border-box}
body{margin:0;background:linear-gradient(180deg,#f8fbff,var(--bg));color:var(--text);padding:20px}
a{color:var(--accent-2)}
.container{max-width:1200px;margin:0 auto}

/* header */
.header{
  display:flex;align-items:center;justify-content:space-between;gap:12px;
  padding:16px;border-radius:14px;background:linear-gradient(90deg,var(--accent),var(--accent-2));
  color:#fff;box-shadow:var(--shadow-lg);margin-bottom:14px;
}
.brand{display:flex;gap:12px;align-items:center}
.logo{width:56px;height:56px;border-radius:10px;background:rgba(255,255,255,0.12);display:grid;place-items:center;font-weight:800}
.brand h1{margin:0;font-size:18px;letter-spacing:0.3px}
.brand p{margin:0;font-size:13px;opacity:.95}
/* user meta */
.user-meta{
  background:rgba(255,255,255,0.12);
  padding:8px 12px;border-radius:999px;font-weight:600;display:flex;gap:8px;align-items:center;font-size:13px;
  min-width:0; max-width:320px; overflow-x:hidden;
}
.user-name-box{ max-height:48px; overflow-y:auto; overflow-x:hidden; white-space:normal; word-break:break-word; }
.user-name-box .name{font-weight:700}
.user-name-box .role{font-size:12px;opacity:.9;color:rgba(255,255,255,0.9)}

/* main card */
.card{background:var(--card);border-radius:12px;padding:16px;box-shadow:var(--shadow-sm)}

/* toolbar */
.toolbar{display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap;margin-bottom:12px}
.search{display:flex;align-items:center;gap:8px;background:linear-gradient(180deg,#fbfdff,#f6f9ff);padding:8px;border-radius:12px;border:1px solid rgba(7,16,36,0.04);flex:1;min-width:180px}
.search input{border:0;background:transparent;outline:none;padding:8px;font-size:14px;width:100%}
.controls{display:flex;gap:8px}
.btn{border:0;padding:9px 14px;border-radius:10px;font-weight:700;cursor:pointer;transition:transform .14s ease}
.btn:active{transform:translateY(1px)}
.btn.primary{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#fff;box-shadow:0 10px 28px rgba(11,108,255,0.12)}
.btn.ghost{background:transparent;border:1px solid rgba(7,16,36,0.06)}
.btn.warn{background:#f59e0b;color:#fff}
.btn.danger{background:var(--danger);color:#fff}

/* table */
.table-wrap{overflow:auto;border-radius:10px}

/* Kh√¥ng √©p b·∫£ng r·ªông, c·ªë ƒë·ªãnh layout ƒë·ªÉ c·ªôt t√™n kh√¥ng k√©o d√†i */
table{
  width:100%;
  border-collapse:collapse;
  min-width:0;
  table-layout:fixed;
  word-break:break-word;
}
thead th{
  padding:12px 14px;font-size:12px;color:var(--muted);text-transform:uppercase;text-align:left;white-space:nowrap;
}
tbody td{
  padding:12px 14px;border-bottom:1px solid rgba(7,16,36,0.04);font-size:14px;white-space:normal;word-break:break-word;
}
tbody tr:hover{background:linear-gradient(90deg, rgba(6,182,212,0.02), rgba(11,108,255,0.02))}

/* category badge (hi·ªÉn th·ªã tr·ª±c ti·∫øp, kh√¥ng c·∫ßn click) */
.cat-badge{
  display:inline-block;
  padding:6px 10px;
  border-radius:999px;
  background:linear-gradient(90deg,#f1f7ff,#eef6ff);
  color:var(--muted);
  font-weight:600;
  font-size:13px;
  border:1px solid rgba(11,108,255,0.06);
}

/* T√™n file: kh√¥ng wrap, ·∫©n/truncate (ellipsis), title ch·ª©a full name */
.name-cell{
  width:340px;
  max-width:340px;
  min-width:0;
  vertical-align:top;
  overflow:visible;
}
.name-cell .cell-inner{
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
  display:block;
  padding-right:6px;
}

/* action buttons: m√†u s·∫Øc r√µ r√†ng */
.action-btn{
  display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border-radius:8px;border:none;color:#fff;cursor:pointer;font-size:13px;
  transition:transform .12s ease, box-shadow .12s ease, opacity .12s ease;
}
.action-btn:active{ transform:translateY(1px) }
.action-btn.edit{ background: linear-gradient(90deg,#06b6d4,#0891b2); box-shadow: 0 6px 16px rgba(6,182,212,0.12); }
.action-btn.perm{ background: linear-gradient(90deg,#0b6cff,#0a58d9); box-shadow: 0 6px 16px rgba(11,108,255,0.12); }
.action-btn.del{ background: linear-gradient(90deg,#ef4444,#dc2626); box-shadow: 0 6px 16px rgba(239,68,68,0.12); }
.action-btn.view{ background: linear-gradient(90deg,#9ca3ff,#7c83ff); box-shadow: 0 6px 16px rgba(124,131,255,0.08); }

/* n√∫t nh·ªè khi hi·ªÉn th·ªã nhi·ªÅu tr√™n 1 √¥ */
.action-btn.small{ padding:6px 8px; font-size:12px }

/* badges */
.badge{padding:6px 8px;border-radius:8px;font-size:12px;color:#fff;display:inline-block}
.badge.all{background:var(--success)}

/* popup form */
.popup{display:none;position:fixed;inset:0;background:rgba(7,16,36,0.45);align-items:center;justify-content:center;z-index:1200;padding:18px}
.form{background:var(--card);padding:18px;border-radius:12px;width:100%;max-width:720px;box-shadow:var(--shadow-lg);max-height:92vh;overflow:auto}
.form h3{margin:0 0 12px;color:var(--accent)}
.form .row{margin-bottom:10px}
.form input, .form textarea, .form select{width:100%;padding:10px;border-radius:8px;border:1px solid #e6e9ef;font-size:14px}
.form .muted{font-size:13px;color:var(--muted)}
.form .multiselect-list{min-height:120px;max-height:220px;overflow:auto}

/* additional small controls for clearing */
.controls-helpers{display:flex;gap:8px;align-items:center;margin-top:6px}

/* mobile cards */
.cards{display:none}
@media (max-width:820px){
  table{min-width:0}
  thead{display:none}
  tbody tr{display:block;margin-bottom:12px;background:var(--card);border-radius:10px;box-shadow:var(--shadow-sm);padding:12px}
  tbody td{display:block;padding:6px 0;border-bottom:none}
  tbody td:before{display:inline-block;width:120px;font-weight:700;color:var(--muted);margin-right:6px}
  tbody td:nth-child(1):before{content:"ID"}
  tbody td:nth-child(2):before{content:"Danh m·ª•c"}
  tbody td:nth-child(3):before{content:"T√™n file"}
  tbody td:nth-child(4):before{content:"URL"}
  tbody td:nth-child(5):before{content:"Quy·ªÅn xem"}
  tbody td:nth-child(6):before{content:"H√†nh ƒë·ªông"}

  .cards{display:flex;flex-direction:column;gap:12px}
  .card-item{background:linear-gradient(180deg,#fff,#fbfdff);padding:12px;border-radius:10px;box-shadow:var(--shadow-sm)}
  .card-item .meta{color:var(--muted);font-size:13px;margin-top:8px;display:flex;gap:8px;flex-wrap:wrap}
}

/* toast & loader */
.toast{position:fixed;left:50%;top:22px;transform:translateX(-50%);background:#071024;color:#fff;padding:10px 14px;border-radius:10px;display:none;z-index:1400;max-width:90%;word-break:break-word}
.toast.show{display:block}
.loader{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(255,255,255,0.6);z-index:1500}
.loader.show{display:flex}
.spinner{width:56px;height:56px;border-radius:12px;background:linear-gradient(180deg,#fff,#f4f7fb);display:grid;place-items:center;box-shadow:var(--shadow-sm);font-weight:700;color:var(--accent-2)}

/* small focus */
input:focus, button:focus, select:focus { outline: 3px solid rgba(11,108,255,0.08); outline-offset:2px; border-radius:8px; }

/* visually hidden for search accessibility */
.sr-only{position:absolute;left:-9999px;top:auto;width:1px;height:1px;overflow:hidden}
</style>
</head>
<body>
  <div class="container">
    <header class="header" role="banner" aria-label="Header qu·∫£n tr·ªã">
      <div class="brand">
        <div class="info"><h1>T√†i Li·ªáu Ng√†nh</h1><p class="muted">B·∫£ng qu·∫£n l√Ω</p></div>
      </div>
      <div style="display:flex;gap:10px;align-items:center">
        <div id="meta" class="user-meta">ƒêang t·∫£i...</div>
        <button id="logoutBtn" class="btn ghost" title="ƒêƒÉng xu·∫•t">ƒêƒÉng xu·∫•t</button>
      </div>
    </header>

    <main class="card" role="main">
      <div class="toolbar">
        <div class="search" role="search" aria-label="T√¨m ki·∫øm">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M21 21l-4.35-4.35" stroke="#667085" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/><path d="M11 19a8 8 0 100-16 8 8 0 000 16z" stroke="#667085" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>
          <input id="q" placeholder="T√¨m theo danh m·ª•c / t√™n file / url / quy·ªÅn..." aria-label="T√¨m vƒÉn b·∫£n">
          <button id="clearSearch" class="btn ghost" title="X√≥a">‚úï</button>
        </div>

        <div class="controls" role="toolbar">
          <button id="btnReload" class="btn ghost" title="L√†m m·ªõi">‚ü≥</button>
          <button id="btnAdd" class="btn primary" title="Th√™m t√†i li·ªáu">+ Th√™m</button>
        </div>
      </div>

      <div class="table-wrap" aria-live="polite">
        <table role="table" aria-label="B·∫£ng t√†i li·ªáu">
          <thead>
            <tr>
              <th style="width:80px">ID</th>
              <th style="width:180px">Danh m·ª•c</th>
              <th style="width:340px">T√™n file</th>
              <th style="width:120px">URL</th>
              <th style="width:140px">Quy·ªÅn xem</th>
              <th style="width:220px"></th>
            </tr>
          </thead>
          <tbody id="tb">
            <tr><td colspan="6" style="text-align:center;padding:18px">Ch∆∞a t·∫£i d·ªØ li·ªáu...</td></tr>
          </tbody>
        </table>
      </div>

      <div class="cards" id="cards" hidden aria-live="polite"></div>
    </main>
  </div>

  <!-- popup form -->
  <div id="popup" class="popup" aria-hidden="true">
    <div class="form" role="dialog" aria-modal="true" aria-labelledby="ftitle">
      <h3 id="ftitle">Th√™m t√†i li·ªáu</h3>
      <input id="fid" type="hidden" />

      <div class="row">
        <label class="muted">Danh m·ª•c (ch·ªçn t·ª´ danh s√°ch)</label>
        <select id="fcategory_select" aria-label="Ch·ªçn danh m·ª•c">
          <option value="">-- Ch·ªçn danh m·ª•c --</option>
        </select>
      </div>

      <div class="row"><label class="muted">T√™n file (name)</label><input id="fname_inp" placeholder="T√™n file (vd: huongdan.pdf)"></div>
      <div class="row"><label class="muted">Slug</label><input id="fslug_inp" placeholder="Slug (kh√¥ng hi·ªÉn th·ªã ·ªü b·∫£ng, d√πng cho URL n·ªôi b·ªô)"></div>
      <div class="row"><label class="muted">URL</label><input id="furl_inp" placeholder="Link ho·∫∑c ƒë∆∞·ªùng d·∫´n n·ªôi b·ªô"></div>

      <hr style="border:none;border-top:1px solid rgba(7,16,36,0.04);margin:12px 0">

      <div class="row"><div class="muted"><strong>Quy·ªÅn xem</strong> ‚Äî Cho ph√©p ai xem t√†i li·ªáu n√†y</div></div>
      <div class="row" style="display:flex;gap:12px;align-items:center">
        <label style="display:flex;gap:8px;align-items:center"><input id="fquyen_all" type="checkbox"> <strong>T·∫•t c·∫£</strong></label>
        <div class="muted">Ho·∫∑c ch·ªçn user b√™n d∆∞·ªõi (Ctrl/Cmd ƒë·ªÉ ch·ªçn nhi·ªÅu)</div>
      </div>

      <div class="row">
        <label class="muted">Ch·ªçn user</label>
        <div style="display:flex;gap:8px;align-items:center">
          <select id="fquyen_select" multiple class="multiselect-list" style="flex:1"></select>
          <div class="controls-helpers" style="flex-direction:column">
            <button id="selectAllBtn" class="btn ghost" title="Ch·ªçn t·∫•t c·∫£" style="white-space:nowrap">Ch·ªçn t·∫•t c·∫£</button>
            <button id="clearSelectBtn" class="btn ghost" title="B·ªè ch·ªçn t·∫•t c·∫£" style="white-space:nowrap">B·ªè ch·ªçn</button>
          </div>
        </div>
        <div class="muted" style="margin-top:6px">Ch·ªçn user m√† t√†i kho·∫£n n√†y ƒë∆∞·ª£c ph√©p xem t√†i li·ªáu. N·∫øu b·∫≠t "T·∫•t c·∫£" th√¨ m·ªçi ng∆∞·ªùi ƒë·ªÅu xem ƒë∆∞·ª£c.</div>
      </div>

      <div style="text-align:right;margin-top:8px;display:flex;gap:8px;justify-content:flex-end">
        <button id="saveBtn" class="btn primary">L∆∞u</button>
        <button id="cancelBtn" class="btn ghost">H·ªßy</button>
      </div>
    </div>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>
  <div id="loader" class="loader" aria-hidden="true"><div class="spinner">‚ü≥</div></div>

<script>
/* ========== CONFIG ========== */
/* Thay API n·∫øu deploy Apps Script kh√°c */
const API = "https://script.google.com/macros/s/AKfycbxe1dxDcrRp5yYz4xNFT4iFqI14XcOzkou8hFOaV0yCgcvCsMjMpYcoyTXAEX4wRAqA/exec";

/* ========== ELEMENTS ========== */
const tb = document.getElementById('tb');
const cardsRoot = document.getElementById('cards');
const popup = document.getElementById('popup');
const toast = document.getElementById('toast');
const loader = document.getElementById('loader');

const btnAdd = document.getElementById('btnAdd');
const btnReload = document.getElementById('btnReload');
const logoutBtn = document.getElementById('logoutBtn');
const clearSearch = document.getElementById('clearSearch');
const qInput = document.getElementById('q');

const fid = document.getElementById('fid');
const fcategory_select = document.getElementById('fcategory_select');
const fname_inp = document.getElementById('fname_inp');
const fslug_inp = document.getElementById('fslug_inp');
const furl_inp = document.getElementById('furl_inp');
const fquyen_all = document.getElementById('fquyen_all');
const fquyen_select = document.getElementById('fquyen_select');
const selectAllBtn = document.getElementById('selectAllBtn');
const clearSelectBtn = document.getElementById('clearSelectBtn');
const saveBtn = document.getElementById('saveBtn');
const cancelBtn = document.getElementById('cancelBtn');
const metaEl = document.getElementById('meta');

let session = null;
let role = '';
let roleLower = '';
let ALL_USERS = [];
let ALL_TITLES = [];
let DATA = [];

/* ========== HELPERS ========== */
function showToast(msg, time=2200){
  toast.textContent = msg;
  toast.classList.add('show');
  setTimeout(()=> toast.classList.remove('show'), time);
}
function showLoader(on=true){
  loader.style.display = on ? 'flex' : 'none';
  loader.setAttribute('aria-hidden', !on);
}
function esc(s){ return String(s||'').replace(/[&<>\"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[c])); }
function parseJwtPayload(t){
  try{
    if(!t || t.indexOf('.')<0) return null;
    let body = t.split('.')[1];
    body = body.replace(/-/g,'+').replace(/_/g,'/');
    while(body.length % 4) body += '=';
    const json = atob(body);
    return JSON.parse(json);
  }catch(e){ return null; }
}
function slugify(s){ if(!s) return ''; let x=String(s).replace(/ƒê/g,'D').replace(/ƒë/g,'d'); x=x.normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/[^a-zA-Z0-9\s-]/g,'').trim().replace(/\s+/g,'-').toLowerCase(); return x; }
function parseQuyen(s){ if(!s) return []; if(String(s).trim().toLowerCase()==='all') return ['all']; return String(s).split(',').map(x=>x.trim()).filter(Boolean); }
function resolveQuyenText(q){
  if(!q) return '-';
  if(String(q).trim().toLowerCase()==='all') return '<span class="badge all">all</span>';
  const arr = parseQuyen(q);
  const names = arr.map(id => { const u = ALL_USERS.find(x=>String(x.id)===String(id)); return u ? (u.username || u.email || id) : id; });
  if(names.length === 0) return '-';
  if(names.length > 3) return `${names.length} users`;
  return esc(names.join(', '));
}

/* ========== AUTH & INIT ========== */
function initAuthAndUI(){
  const raw = localStorage.getItem('loggedInUser');
  if(!raw){ alert('Vui l√≤ng ƒëƒÉng nh·∫≠p'); location.href = '/login.html'; return; }
  try{
    session = JSON.parse(raw);
    const tok = session.token || (session.user && session.user.token) || '';
    let r = (session.user && session.user.role) || '';
    if(!r && tok){ const payload = parseJwtPayload(tok); if(payload) r = payload.role || ''; }
    role = r || '';
    roleLower = String(role).toLowerCase();

    const displayName = esc(session.user?.username || session.user?.email || 'Admin');
    metaEl.innerHTML = `<div class="user-name-box"><div class="name">${displayName}</div><div class="role">Role: ${esc(role||'')}</div></div>`;

    if(!role || (roleLower !== 'admin' && roleLower !== 'editor')){ alert('B·∫°n kh√¥ng c√≥ quy·ªÅn truy c·∫≠p trang n√†y'); localStorage.removeItem('loggedInUser'); location.href='/login.html'; return; }

    if(roleLower !== 'admin' && roleLower !== 'editor'){ btnAdd.style.display = 'none'; }

  }catch(e){
    console.error(e); localStorage.removeItem('loggedInUser'); alert('Token kh√¥ng h·ª£p l·ªá'); location.href='/login.html';
  }
}

/* ========== LOAD USERS ========== */
async function loadUsers(){
  try{
    let users = [];
    if(roleLower === 'admin'){
      const body = new URLSearchParams({ route:'users-list', token: session.token });
      const res = await fetch(API, { method:'POST', body });
      const j = await res.json();
      if(j && j.status === 'success') users = j.data || [];
    } else {
      const res = await fetch(API);
      const j = await res.json();
      users = (j && j.data && j.data.Users) ? j.data.Users : [];
    }
    ALL_USERS = users;
    populateUserSelect();
  }catch(e){
    console.error('loadUsers', e);
    ALL_USERS = [];
    populateUserSelect();
  }
}
function populateUserSelect(){
  fquyen_select.innerHTML = '';
  ALL_USERS.forEach(u=>{
    const opt = document.createElement('option');
    opt.value = u.id || u.email || u.username || '';
    opt.textContent = u.username || u.email || u.id || '';
    fquyen_select.appendChild(opt);
  });
}

/* ========== populate categories into select ========== */
function populateCategories(){
  fcategory_select.innerHTML = '<option value="">-- Ch·ªçn danh m·ª•c --</option>';
  ALL_TITLES.forEach(t => {
    const opt = document.createElement('option');
    opt.value = t;
    opt.textContent = t;
    fcategory_select.appendChild(opt);
  });
}

/* ========== LOAD DOCUMENTS ========= */
async function loadDocs(){
  tb.innerHTML = `<tr><td colspan="6" style="text-align:center;padding:18px">ƒêang t·∫£i...</td></tr>`;
  cardsRoot.innerHTML = '';
  cardsRoot.hidden = true;
  showLoader(true);
  try{
    const body = new URLSearchParams({ route:'tailieu-list', token: session.token });
    const res = await fetch(API, { method:'POST', body });
    const j = await res.json();
    if(!j || j.status !== 'success'){ tb.innerHTML = `<tr><td colspan="6" style="text-align:center;padding:18px">${esc(j && j.message ? j.message : 'Kh√¥ng th·ªÉ l·∫•y d·ªØ li·ªáu')}</td></tr>`; showLoader(false); return; }
    let items = j.data || [];

    items = items.filter(it => it && it.title && String(it.title).trim());

    const uid = String(session.user?.id || session.user?.email || session.user?.username || '').trim();

    const visible = items.filter(it => {
      if(roleLower === 'admin') return true;
      const qArr = parseQuyen(it.quyen || '');
      if(qArr.includes('all')) return true;
      return qArr.includes(uid);
    });

    DATA = visible.slice();

    ALL_TITLES = Array.from(new Set(visible.map(it => (it.title||'').trim()).filter(Boolean)));
    populateCategories();

    if(visible.length === 0){ tb.innerHTML = `<tr><td colspan="6" style="text-align:center;padding:18px">Kh√¥ng c√≥ t√†i li·ªáu ng√†nh ƒë∆∞·ª£c ph√©p xem.</td></tr>`; showLoader(false); return; }

    tb.innerHTML = visible.map(it=>{
      const id = esc(it.id||'');
      const title = esc(it.title||'');
      const name = esc(it.name||'');
      const urlCell = it.url ? `<a href="${esc(it.url)}" target="_blank" rel="noopener">Link</a>` : '-';
      const quyenText = resolveQuyenText(it.quyen||'');
      const djson = esc(JSON.stringify(it||{}));

      const qArr = parseQuyen(it.quyen || '');
      const uidNow = String(session.user?.id || session.user?.email || session.user?.username || '').trim();
      const canEditorModify = (roleLower === 'admin') || (roleLower === 'editor' && (qArr.includes('all') || qArr.includes(uidNow)));

      const actionsForAdmin = `<button class="action-btn edit" data-act="edit" data-json='${djson}'>‚úè S·ª≠a</button>
                               <button class="action-btn perm" data-act="perm" data-json='${djson}'>‚öô Quy·ªÅn</button>
                               <button class="action-btn del" data-act="del" data-id="${id}">üóë X√≥a</button>`;
      const actionsForEditorAllowed = `<button class="action-btn edit" data-act="edit" data-json='${djson}'>‚úè S·ª≠a</button>
                                      <button class="action-btn del" data-act="del" data-id="${id}">üóë X√≥a</button>`;
      const actionsForViewer = `<button class="action-btn view" data-act="edit" data-json='${djson}'>üëÅÔ∏è Xem</button>`;

      let actionsHtml = '';
      if(roleLower === 'admin') actionsHtml = actionsForAdmin;
      else if(roleLower === 'editor') actionsHtml = canEditorModify ? actionsForEditorAllowed : actionsForViewer;
      else actionsHtml = actionsForViewer;

      // note: removed slug column (no longer rendered)
      return `<tr data-id="${id}">
        <td style="max-width:120px;word-break:break-word">${id}</td>
        <td><span class="cat-badge">${title}</span><span class="sr-only">${title}</span></td>
        <td class="name-cell"><div class="cell-inner" title="${name}">${name}</div></td>
        <td style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${urlCell}</td>
        <td title="${esc(it.quyen||'')}" style="white-space:nowrap">${quyenText}</td>
        <td style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
          ${actionsHtml}
        </td>
      </tr>`;
    }).join('');

    // mobile cards (slug removed)
    cardsRoot.hidden = false;
    cardsRoot.innerHTML = visible.map(it => {
      const title = esc(it.title||'');
      const name = esc(it.name||'');
      const urlCell = it.url ? `<a href="${esc(it.url)}" target="_blank" rel="noopener">Link</a>` : '-';
      const quyenText = resolveQuyenText(it.quyen||'');
      const id = esc(it.id||'');
      const qArr = parseQuyen(it.quyen || '');
      const uidNow = String(session.user?.id || session.user?.email || session.user?.username || '').trim();
      const canEditorModify = (roleLower === 'admin') || (roleLower === 'editor' && (qArr.includes('all') || qArr.includes(uidNow)));

      const actions = roleLower === 'admin' ? `<div style="display:flex;gap:8px"><button class="btn ghost" onclick="openEditFromCard('${id}')">S·ª≠a</button><button class="btn danger" onclick="deleteDoc('${id}')">X√≥a</button></div>`
                    : (roleLower === 'editor' && canEditorModify) ? `<div style="display:flex;gap:8px"><button class="btn ghost" onclick="openEditFromCard('${id}')">S·ª≠a</button><button class="btn danger" onclick="deleteDoc('${id}')">X√≥a</button></div>`
                    : `<div style="display:flex;gap:8px"><button class="btn ghost" onclick="openEditFromCard('${id}')">Xem</button></div>`;

      return `<div class="card-item" role="article">
                <div style="display:flex;justify-content:space-between;align-items:center">
                  <strong><span class="cat-badge">${title}</span></strong>
                  <div class="muted">${urlCell}</div>
                </div>
                <div class="meta muted" style="margin-top:8px">T√™n file vƒÉn b·∫£n: ${name} ‚Ä¢ Quy·ªÅn: ${quyenText}</div>
                ${actions}
              </div>`;
    }).join('');

    attachRowListeners();
  }catch(e){
    console.error('loadDocs', e);
    tb.innerHTML = `<tr><td colspan="6" style="text-align:center;padding:18px">L·ªói t·∫£i d·ªØ li·ªáu</td></tr>`;
    showToast('L·ªói khi t·∫£i d·ªØ li·ªáu');
  }finally{
    showLoader(false);
  }
}

/* ========== attach row listeners for edit/delete/perm ========== */
function attachRowListeners(){
  const uid = String(session.user?.id || session.user?.email || session.user?.username || '').trim();

  document.querySelectorAll('button[data-act]').forEach(b=>{
    const act = b.getAttribute('data-act');
    b.onclick = ()=>{
      if(act === 'edit' || act === 'perm'){
        try{
          const data = JSON.parse(b.getAttribute('data-json'));
          const qArr = parseQuyen(data.quyen || '');
          const canModify = (roleLower === 'admin') || (roleLower === 'editor' && (qArr.includes('all') || qArr.includes(uid)));
          if(act === 'perm' && roleLower !== 'admin'){
            alert('Ch·ªâ admin m·ªõi c√≥ th·ªÉ thay ƒë·ªïi quy·ªÅn.');
            return;
          }
          const readOnly = !canModify;
          openEditForm(data, readOnly);
        }catch(e){
          const readOnlyFallback = roleLower !== 'admin';
          openEditForm({ id: b.dataset.id }, readOnlyFallback);
        }
      } else if(act === 'del'){
        const id = b.dataset.id;
        const item = DATA.find(x=>String(x.id)===String(id));
        const qArr = parseQuyen(item?.quyen || '');
        const canDelete = (roleLower === 'admin') || (roleLower === 'editor' && (qArr.includes('all') || qArr.includes(uid)));
        if(!canDelete){
          alert('B·∫°n kh√¥ng c√≥ quy·ªÅn x√≥a m·ª•c n√†y.');
          return;
        }
        if(confirm('B·∫°n ch·∫Øc ch·∫Øn mu·ªën x√≥a?')) deleteDoc(id);
      }
    };
  });
}

/* ========== popup open/close ========== */
function openEditForm(item = {}, readOnly = false){
  document.getElementById('ftitle').textContent = item && item.id ? (readOnly ? 'Xem t√†i li·ªáu' : 'S·ª≠a t√†i li·ªáu') : 'Th√™m t√†i li·ªáu';
  fid.value = item.id || '';
  if(item && item.title){
    const t = String(item.title);
    if(t && !ALL_TITLES.includes(t)){
      ALL_TITLES.unshift(t);
      populateCategories();
    }
    fcategory_select.value = t;
  } else {
    fcategory_select.value = '';
  }
  fname_inp.value = item.name || '';
  fslug_inp.value = item.slug || (item.title ? slugify(item.title) : '');
  furl_inp.value = item.url || '';
  fquyen_all.checked = false;
  Array.from(fquyen_select.options).forEach(o=> o.selected = false);
  if(item && item.quyen){
    const q = String(item.quyen).trim();
    if(q.toLowerCase() === 'all') fquyen_all.checked = true;
    else {
      const arr = q.split(',').map(x=>x.trim()).filter(Boolean);
      arr.forEach(id => {
        const opt = fquyen_select.querySelector(`option[value="${id}"]`);
        if(opt) opt.selected = true;
      });
    }
  }

  Array.from(document.querySelectorAll('.form input, .form select')).forEach(el => el.disabled = !!readOnly);
  if(readOnly) saveBtn.style.display = 'none'; else saveBtn.style.display = '';

  popup.style.display = 'flex';
  popup.setAttribute('aria-hidden','false');
  setTimeout(()=> document.querySelector('.form').classList.add('show'), 20);
}
function closePopup(){
  document.querySelector('.form').classList.remove('show');
  setTimeout(()=> { popup.style.display = 'none'; popup.setAttribute('aria-hidden','true'); }, 160);
}
cancelBtn.onclick = closePopup;
function openEditFromCard(id){
  const it = DATA.find(x=>String(x.id)===String(id));
  if(it){
    const qArr = parseQuyen(it.quyen || '');
    const uid = String(session.user?.id || session.user?.email || session.user?.username || '').trim();
    const canModify = (roleLower === 'admin') || (roleLower === 'editor' && (qArr.includes('all') || qArr.includes(uid)));
    openEditForm(it, !canModify);
  } else {
    openEditForm({ id }, roleLower !== 'admin');
  }
}

/* multiselect helpers */
selectAllBtn.addEventListener('click', ()=> {
  Array.from(fquyen_select.options).forEach(o => o.selected = true);
  fquyen_all.checked = false;
  showToast('ƒê√£ ch·ªçn t·∫•t c·∫£ user');
});
clearSelectBtn.addEventListener('click', ()=> {
  Array.from(fquyen_select.options).forEach(o => o.selected = false);
  fquyen_all.checked = false;
  showToast('ƒê√£ b·ªè ch·ªçn t·∫•t c·∫£ user');
});
fquyen_all.addEventListener('change', ()=> {
  if(fquyen_all.checked){
    Array.from(fquyen_select.options).forEach(o => o.selected = false);
    showToast('B·∫≠t "T·∫•t c·∫£" ‚Äî m·ªçi user ƒë∆∞·ª£c ph√©p xem');
  }
});

/* save document */
async function saveDocument(){
  const id = fid.value;
  const route = id ? 'tailieu-update' : 'tailieu-add';
  let quyen = '';
  if(fquyen_all.checked) quyen = 'all';
  else {
    const sel = Array.from(fquyen_select.selectedOptions).map(o=>o.value).filter(Boolean);
    quyen = sel.join(',');
  }

  const selectedTitle = (fcategory_select.value || '').trim();

  const payload = {
    token: session.token,
    id,
    title: selectedTitle,
    name: fname_inp.value.trim(),
    slug: fslug_inp.value.trim() || slugify(selectedTitle),
    url: furl_inp.value.trim(),
    quyen
  };
  if(!payload.title){ showToast('Vui l√≤ng ch·ªçn danh m·ª•c (kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng)'); return; }
  showLoader(true);
  try{
    const res = await fetch(API + '?route=' + route, { method:'POST', body: new URLSearchParams(payload) });
    const j = await res.json();
    if(j && (j.status === 'success' || j.id || j.http_status === 201)){ showToast(j.message || 'L∆∞u th√†nh c√¥ng'); closePopup(); await loadDocs(); }
    else showToast(j && j.message ? j.message : 'L·ªói l∆∞u d·ªØ li·ªáu');
  }catch(e){
    console.error('save', e);
    showToast('L·ªói khi l∆∞u d·ªØ li·ªáu');
  }finally{ showLoader(false); }
}
saveBtn.addEventListener('click', saveDocument);

/* delete */
async function deleteDoc(id){
  const item = DATA.find(x=>String(x.id)===String(id));
  const uid = String(session.user?.id || session.user?.email || session.user?.username || '').trim();
  const qArr = parseQuyen(item?.quyen || '');
  const canDelete = (roleLower === 'admin') || (roleLower === 'editor' && (qArr.includes('all') || qArr.includes(uid)));
  if(!canDelete){
    showToast('B·∫°n kh√¥ng c√≥ quy·ªÅn x√≥a m·ª•c n√†y');
    return;
  }

  showLoader(true);
  try{
    const res = await fetch(API + '?route=tailieu-delete', { method:'POST', body: new URLSearchParams({ token: session.token, id }) });
    const j = await res.json();
    if(j && j.status === 'success'){ showToast(j.message || 'ƒê√£ x√≥a'); await loadDocs(); }
    else showToast(j && j.message ? j.message : 'L·ªói x√≥a');
  }catch(e){
    console.error('delete', e);
    showToast('L·ªói x√≥a');
  }finally{ showLoader(false); }
}

/* UI events */
btnAdd.addEventListener('click', ()=> openEditForm());
btnReload.addEventListener('click', async ()=> { await loadUsers(); await loadDocs(); });
logoutBtn.addEventListener('click', ()=> { localStorage.removeItem('loggedInUser'); location.href = '/login.html'; });
clearSearch.addEventListener('click', ()=> { qInput.value=''; qInput.dispatchEvent(new Event('input')); });

qInput.addEventListener('input', ()=> {
  const v = qInput.value.trim().toLowerCase();
  Array.from(tb.querySelectorAll('tr')).forEach(tr => {
    tr.style.display = tr.textContent.toLowerCase().includes(v) ? '' : 'none';
  });
  Array.from(cardsRoot.children).forEach(c => { c.style.display = c.textContent.toLowerCase().includes(v) ? '' : 'none'; });
});

/* ESC to close popup */
document.addEventListener('keydown', (e)=> { if(e.key === 'Escape') closePopup(); });

/* responsive toggle */
function updateResponsive(){ if(window.innerWidth <= 820){ document.querySelector('.table-wrap').style.display = 'none'; cardsRoot.style.display = ''; } else { document.querySelector('.table-wrap').style.display = ''; cardsRoot.style.display = 'none'; } }
window.addEventListener('resize', updateResponsive);
updateResponsive();

/* init */
async function bootstrap(){
  try{
    const raw = localStorage.getItem('loggedInUser');
    if(!raw){ alert('Vui l√≤ng ƒëƒÉng nh·∫≠p'); location.href = '/login.html'; return; }
    session = JSON.parse(raw);
    const tok = session.token || (session.user && session.user.token) || '';
    let r = (session.user && session.user.role) || '';
    if(!r && tok){ const payload = parseJwtPayload(tok); if(payload) r = payload.role || ''; }
    role = r || '';
    roleLower = String(role).toLowerCase();

    const displayName = esc(session.user?.username || session.user?.email || 'Admin');
    metaEl.innerHTML = `<div class="user-name-box"><div class="name">${displayName}</div><div class="role">Role: ${esc(role||'')}</div></div>`;

    if(!role || (roleLower !== 'admin' && roleLower !== 'editor')){ alert('B·∫°n kh√¥ng c√≥ quy·ªÅn truy c·∫≠p trang n√†y'); localStorage.removeItem('loggedInUser'); location.href='/login.html'; return; }

    if(roleLower !== 'admin' && roleLower !== 'editor'){ btnAdd.style.display = 'none'; }

    showLoader(true);
    await loadUsers();
    await loadDocs();
  }catch(e){
    console.error('bootstrap', e);
    showToast('L·ªói kh·ªüi t·∫°o');
  }finally{
    showLoader(false);
  }
}
initAuthAndUI();
bootstrap();
</script>
</body>
</html>
