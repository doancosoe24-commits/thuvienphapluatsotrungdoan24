<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Quản lý - Thư Viện Pháp Luật Số Sư Đoàn 10</title>
<link rel="shortcut icon" href="./img/logo.png" type="image/x-icon">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#f6f8fb; --card:#ffffff; --text:#0f172a;
  --accent:#0b63d1; --accent-2:#06b6d4; --muted:#6b7280;
  --radius:14px; --gap:14px; --shadow:0 10px 30px rgba(15,23,42,0.06);
  --glass: rgba(255,255,255,0.6);
  font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;background:linear-gradient(180deg,var(--bg),#eef4fb);color:var(--text);-webkit-font-smoothing:antialiased}
img{max-width:100%;height:auto}
a{color:inherit;text-decoration:none}
:focus{outline:2px solid rgba(11,99,209,0.18);outline-offset:2px}
.container{max-width:100%;margin:0 auto;padding:16px}
/* Top bar (mobile-first) */
.topbar{
  display:flex;align-items:center;gap:12px;padding:12px;border-radius:12px;background:linear-gradient(180deg,var(--card),#fbfdff);box-shadow:var(--shadow);backdrop-filter:blur(6px);
}
.brand{display:flex;align-items:center;gap:12px}
.brand .logo{width:48px;height:48px;border-radius:10px;overflow:hidden;flex-shrink:0}
.brand .title{font-weight:700;font-size:16px}
.hamburger{width:44px;height:44px;display:grid;place-items:center;border-radius:12px;border:0;background:transparent;color:var(--accent);cursor:pointer}
.hamburger:hover{transform:translateY(-2px)}
.searchBar{flex:1;display:flex;align-items:center;background:rgba(15,23,42,0.03);padding:8px;border-radius:12px;gap:8px}
.searchBar input{border:0;background:transparent;outline:none;flex:1;padding:6px 4px;font-size:15px}
.header-actions{display:flex;align-items:center;gap:10px}
.avatar{width:44px;height:44px;border-radius:999px;background:linear-gradient(135deg,var(--accent),var(--accent-2));display:grid;place-items:center;color:white;font-weight:700;font-size:16px}
.fab-menu{position:fixed;right:18px;bottom:18px;width:56px;height:56px;border-radius:999px;background:linear-gradient(135deg,var(--accent),#0ea5a3);box-shadow:0 8px 22px rgba(11,99,209,0.18);display:grid;place-items:center;color:#fff;font-size:22px;z-index:60}
/* Sidebar as slide-over */
.sidebar{
  position:fixed;overflow-y: scroll;inset:0 auto 0 0;width:320px;max-width:92vw;background:var(--card);box-shadow:var(--shadow);padding:18px;transform:translateX(-120%);transition:transform .32s cubic-bezier(.2,.9,.25,1);z-index:70;border-top-right-radius:12px;border-bottom-right-radius:12px}
.sidebar.open{transform:translateX(0)}
.sidebar .brand-mini{display:flex;align-items:center;gap:12px;margin-bottom:12px}
.sidebar .brand-mini .logo{width:56px;height:56px}
.menu{display:flex;flex-direction:column;gap:6px}
.menu a{display:flex;align-items:center;gap:12px;padding:10px;border-radius:10px;font-weight:600;color:var(--text);transition:background .18s}
.menu a svg{flex-shrink:0;width:20px;height:20px;opacity:.85}
.menu a:hover{background:linear-gradient(90deg, rgba(11,99,209,0.06), rgba(6,182,212,0.04));transform:translateY(-2px)}
.menu a[aria-current="true"]{background:linear-gradient(90deg, rgba(11,99,209,0.12), rgba(6,182,212,0.03));box-shadow:0 6px 18px rgba(11,99,209,0.04)}
.logout{margin-top:8px;padding:10px;border-radius:10px;background:linear-gradient(180deg,#fff, #fff);border:1px solid rgba(11,99,209,0.06)}
/* Content area */
.content-wrap{margin-top:14px}
.panel{background:var(--card);padding:12px;border-radius:12px;box-shadow:var(--shadow)}
.iframe-wrap{margin-top:12px;border-radius:12px;overflow:hidden}
iframe#contentFrame{width:100%;height:70vh;border:0;display:block;background:#fff}
/* Desktop tweaks */
@media(min-width:900px){
  .sidebar{transform:none;position:fixed;left:24px;top:24px;bottom:24px;width:260px;max-width:none;border-radius:12px}
  .container{display:grid;grid-template-columns:260px 1fr;gap:20px;align-items:start}
  .topbar{grid-column:2/span 1}
  .content-wrap{grid-column:2/span 1}
  iframe#contentFrame{height:calc(100vh - 140px)}
  .fab-menu{display:none}
}
/* small devices */
@media(max-width:420px){
  .brand .title{font-size:14px}
  .searchBar{
    overflow: hidden;
  }
  .searchBar input{font-size:14px}
  .hamburger{width:44px;height:44px}
}
/* utilities */
.kv{display:flex;gap:8px;align-items:center}
.btn{padding:8px 12px;border-radius:10px;border:0;cursor:pointer;background:var(--accent);color:#fff;font-weight:600}
.small{font-size:13px;color:var(--muted)}
</style>
</head>
<body>

<!-- Loader / protect notice -->
<div id="protectLoader" style="position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(255,255,255,0.9);z-index:9999;font-size:15px;color:var(--muted)">Đang kiểm tra quyền truy cập — vui lòng chờ...</div>

<!-- sidebar (offcanvas on mobile) -->
<aside class="sidebar" id="sidebar" aria-hidden="true" aria-label="Menu quản trị">
  <div class="brand-mini">
    <div class="logo"><img src="./img/logo1.jpg" alt="logo" onerror="this.src='./img/logo.png'" style="width:100%;height:100%;object-fit:cover"></div>
    <div>
      <div style="font-weight:800;color:var(--accent)">Thư Viện Pháp Luật</div>
      <div class="small">Trung đoàn 24 — Khu vực quản trị</div>
    </div>
  </div>

  <nav class="menu" role="navigation" aria-label="Menu chính">
    <a href="dashboard.html" aria-current="true"><svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3 13h8V3H3v10zM13 21h8V11h-8v10zM13 3v6h8V3h-8zM3 21h8v-6H3v6z" fill="currentColor"/></svg>Trang chủ</a>
    <a href="quanly_users.html"><svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 12c2.7 0 5-2.3 5-5s-2.3-5-5-5-5 2.3-5 5 2.3 5 5 5zM4 20c0-3.3 4.7-5 8-5s8 1.7 8 5v1H4v-1z" fill="currentColor"/></svg>Tài khoản</a>
    <a href="quanly_thuvienphapluatso.html"><svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3 3h18v2H3V3zm0 4h12v12H3V7zm14 0h2v12h-2V7z" fill="currentColor"/></svg>Thư viện pháp luật số</a>
    <a href="quanly_tailieunganh.html"><svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M4 4h16v2H4zM6 8h12v12H6z" fill="currentColor"/></svg>Tài liệu ngành</a>
    <a href="quanly_tailieutaphuan.html"><svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 2L2 7l10 5 10-5-10-5zm0 7v13" stroke="currentColor" stroke-width="1.2" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg>Tập huấn</a>
    <a href="quanly_tailieuthamkhao.html"><svg viewBox="0 0 24 24"><path d="M4 4h16v16H4z" fill="currentColor"/></svg>Tài liệu tham khảo</a>
     <a href="quanly_hoctaplamtheotutuonghochiminh.html"><svg viewBox="0 0 24 24"><path d="M12 8a4 4 0 100 8 4 4 0 000-8z" fill="currentColor"/></svg>Học Tập Theo Tư Tưởng HCM</a>
      <a href="quanly_truyenthongtrungdoan24.html"><svg viewBox="0 0 24 24"><path d="M12 8a4 4 0 100 8 4 4 0 000-8z" fill="currentColor"/></svg>Truyền Thông Trung Đoàn 24</a>
      <a href="quanly_congtacquansu.html"><svg viewBox="0 0 24 24"><path d="M12 8a4 4 0 100 8 4 4 0 000-8z" fill="currentColor"/></svg>Tài Liệu Công Tác Quân Sự</a>
    <a href="quanly_history.html"><svg viewBox="0 0 24 24"><path d="M12 8v5l3 3" fill="currentColor"/></svg>Lịch sử đăng nhập</a>
    <a href="quanly_setting.html"><svg viewBox="0 0 24 24"><path d="M12 8a4 4 0 100 8 4 4 0 000-8z" fill="currentColor"/></svg>Cài đặt</a>
     <a href="quanly_chat.html" sandbox="allow-scripts allow-same-origin allow-popups">
      <svg viewBox="0 0 24 24" aria-hidden="true">
  <path
    fill="currentColor"
    d="M12 2C6.48 2 2 6.02 2 11c0 2.62 1.25 5 3.29 6.62V22l4.07-2.24c.85.23 1.74.36 2.64.36 5.52 0 10-4.02 10-9s-4.48-9-10-9z"
  />
</svg>
      Tin nhắn nội bộ</a>
    <a class="logout" href="javascript:void(0);" onclick="logout()">Đăng xuất</a>
  </nav>
</aside>

<!-- floating action button (mobile) -->
<button  id="openMenuBtn" aria-label="Mở menu"></button>

<div class="container">

  <!-- Topbar -->
  <header class="topbar" role="banner">
    <div class="brand">
      <button class="hamburger" id="menuToggle" aria-label="Mở menu">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M4 6h16M4 12h16M4 18h16" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>
      </button>
    </div>

    <div class="searchBar" role="search">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M21 21l-4.35-4.35" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/><path d="M11 19a8 8 0 100-16 8 8 0 000 16z" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>
      <input id="quickSearch" type="search" placeholder="Tìm nhanh" aria-label="Tìm nhanh">
      <button id="clearSearch" aria-label="Xoá tìm kiếm" style="background:transparent;border:0;padding:6px 0;display:none">✕</button>
    </div>

    <div class="header-actions">
      <div id="adminAvatar" class="avatar" title="User">Q</div>
    </div>
  </header>

  <!-- main content -->
  <main class="content-wrap"> 
    <div class="panel">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap">
        <div>
          <div style="font-weight:800;font-size:18px">Bảng điều khiển</div>
          <div class="small">Quản lý tài liệu, người dùng và cấu hình hệ thống</div>
        </div>
        <div style="display:flex;gap:10px;align-items:center">
          <button class="btn" id="newItemBtn">Thêm tài liệu</button>
          <button class="btn" ><a href="main.html">xem website</a></button>
          <button class="btn" style="background:#fff;color:var(--accent);border:1px solid rgba(11,99,209,0.08)" id="refreshBtn">Làm mới</button>
        </div>
      </div>
    </div>
    <div class="iframe-wrap">
<iframe id="contentFrame" src="dashboard.html" title="Nội dung quản trị"
        sandbox="allow-scripts allow-same-origin allow-modals allow-popups allow-downloads">
</iframe>
    </div>
  </main>
</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbwHc9P_C0PL7y1qiTVTxrqqwc50CqVoOWSTxCyEdu3dWIaUeP0ljTd4GSGXndaik0Gx/exec";

/* =========== PROTECT PAGE =========== */
(async function protectAdminPage(){
  try {
    const raw = localStorage.getItem("loggedInUser");
    if(!raw){
      alert("Bạn cần đăng nhập.");
      window.location.href = "index.html";
      return;
    }
    let parsed;
    try { parsed = JSON.parse(raw); } catch(e) { parsed = raw; }
    const token = (parsed && parsed.token) || (parsed && parsed.user && (parsed.user.token || parsed.user.accessToken)) || null;
    if(!token){
      alert("Không tìm thấy token, vui lòng đăng nhập lại.");
      localStorage.removeItem("loggedInUser");
      window.location.href = "index.html";
      return;
    }
    // prefer check-manager, fallback to check-admin
    const resp = await fetch(`${API_URL}?route=check-manager&token=${encodeURIComponent(token)}`);
    if(!resp.ok){
      const fb = await fetch(`${API_URL}?route=check-admin&token=${encodeURIComponent(token)}`).catch(()=>null);
      if(fb && fb.ok){
        const fbd = await fb.json();
        if(fbd && fbd.status === 'success' && fbd.isAdmin){
          window.__CURRENT_ADMIN_TOKEN = token;
          window.__CURRENT_ADMIN_USER = (parsed && parsed.user) || fbd.user || {};
          document.getElementById('protectLoader').remove();
          initAfterAuth(true);
          return;
        }
      }
      alert("Lỗi xác thực. Vui lòng đăng nhập lại.");
      localStorage.removeItem("loggedInUser");
      window.location.href = "index.html";
      return;
    }
    const data = await resp.json();
    if(!data || data.status !== 'success' || !data.isManager){
      alert("Bạn không có quyền truy cập (chỉ admin hoặc editor).");
      window.location.href = "index.html";
      return;
    }
    window.__CURRENT_ADMIN_TOKEN = token;
    window.__CURRENT_ADMIN_USER = (data.user && Object.keys(data.user).length) ? data.user : ((parsed && parsed.user) || {});
    const loader = document.getElementById('protectLoader'); if(loader) loader.remove();
    initAfterAuth(true);
  } catch (err) {
    console.error("protectAdminPage error:", err);
    alert("Lỗi khi kiểm tra quyền. Về trang chủ.");
    window.location.href = "index.html";
  }
})();

function initAfterAuth(isManager){
  try{
    const user = window.__CURRENT_ADMIN_USER || {};
    const name = (user.username || user.email || user.name || "Q").toString();
    const av = document.getElementById('adminAvatar'); av.textContent = name.charAt(0).toUpperCase(); av.title = name;

    // simple access control (hide menu entries if not allowed)
    const checkVal = (user.check !== undefined && user.check !== null) ? String(user.check).trim().toLowerCase() : 'all';
    const accessMap = {
      'all': ['dashboard.html','quanly_users.html','quanly_thuvienphapluatso.html','quanly_tailieunganh.html','quanly_tailieutaphuan.html','quanly_tailieuthamkhao.html','quanly_category.html','quanly_setting.html'],
      '1': ['quanly_thuvienphapluatso.html'],
      '2': ['quanly_tailieunganh.html'],
      '3': ['quanly_tailieutaphuan.html','quanly_tailieuthamkhao.html'],
      '4': ['quanly_category.html','quanly_setting.html']
    };
    const allowed = accessMap[checkVal] || [];
    const navLinks = Array.from(document.querySelectorAll('.menu a'));
    navLinks.forEach(a=>{
      const href = (a.getAttribute('href')||'').trim();
      const isLogout = a.classList.contains('logout');
      if(checkVal === 'all' || isLogout || allowed.includes(href)){
        a.style.display = '';
      } else {
        a.style.display = 'none';
      }
    });
    // if limited, show notice
    if(checkVal !== 'all'){
      const note = document.createElement('div');
      note.className = 'panel'; note.style.marginTop='12px'; note.innerHTML = '<strong>Quyền hạn bị giới hạn</strong> — bạn chỉ truy cập các mục được phân quyền.';
      document.querySelector('.content-wrap').insertBefore(note, document.querySelector('.content-wrap').firstChild);
    }

    // iframe default
    const iframe = document.getElementById('contentFrame');
    if(iframe){
      if(checkVal === 'all') iframe.src = 'dashboard.html';
      else if(allowed.length) iframe.src = allowed[0];
      else iframe.src = 'dashboard.html';
    }

    bindUI();
  }catch(e){console.error(e)}
}

function bindUI(){
  const sidebar = document.getElementById('sidebar');
  const menuToggle = document.getElementById('menuToggle');
  const openMenuBtn = document.getElementById('openMenuBtn');
  const links = Array.from(document.querySelectorAll('.menu a'));
  const iframe = document.getElementById('contentFrame');
  const quickSearch = document.getElementById('quickSearch');
  const clearSearch = document.getElementById('clearSearch');

  function closeSidebar(){ sidebar.classList.remove('open'); sidebar.setAttribute('aria-hidden','true'); }
  function openSidebar(){ sidebar.classList.add('open'); sidebar.setAttribute('aria-hidden','false'); }

  menuToggle.addEventListener('click', ()=>{ if(window.innerWidth < 900) openSidebar(); else { /* focus search on desktop */ document.getElementById('quickSearch').focus(); } });
  openMenuBtn.addEventListener('click', ()=> openSidebar());

  // close sidebar when clicking outside
  document.addEventListener('click', (e)=>{
    if(!sidebar.contains(e.target) && !menuToggle.contains(e.target) && window.innerWidth < 900){ closeSidebar(); }
  });

  // link navigation into iframe
  links.forEach(link=>{
    link.addEventListener('click', e=>{
      const href = link.getAttribute('href');
      if(!href || href.startsWith('javascript')) return;
      e.preventDefault();
      links.forEach(l=>l.removeAttribute('aria-current'));
      link.setAttribute('aria-current','true');
      iframe.src = href;
      if(window.innerWidth < 900) closeSidebar();
    });
  });

  // quick search: postMessage to iframe if available
  let lastQ = '';
  quickSearch.addEventListener('input', ()=>{
    const q = quickSearch.value.trim();
    clearSearch.style.display = q ? 'inline-block' : 'none';
    try{ const win = iframe.contentWindow; win.postMessage({type:'quick-search', q}, '*'); }catch(e){}
    lastQ = q;
  });
  clearSearch.addEventListener('click', ()=>{ quickSearch.value = ''; quickSearch.dispatchEvent(new Event('input')); quickSearch.focus(); });

  // make iframe height responsive on desktop
  function updateIframeHeight(){
    const headerH = document.querySelector('.topbar').getBoundingClientRect().height;
    const vh = window.innerHeight;
    iframe.style.height = `${Math.max(320, vh - headerH - 120)}px`;
  }
  window.addEventListener('resize', updateIframeHeight);
  setTimeout(updateIframeHeight,120);

  // utility buttons
  document.getElementById('refreshBtn').addEventListener('click', ()=>{ iframe.contentWindow ? iframe.contentWindow.location.reload() : iframe.contentWindow = iframe.contentWindow; });
  document.getElementById('newItemBtn').addEventListener('click', ()=>{ alert('Chức năng thêm tài liệu — mở trang quản lý tài liệu.'); iframe.src = 'quanly_tailieunganh.html'; });
}

function logout(){ localStorage.removeItem('loggedInUser'); window.location.href='index.html'; }

// expose globals
window.__TOKEN = window.__TOKEN || '';
window.__CURRENT_USER = window.__CURRENT_USER || {};
</script>

</body>
</html>
